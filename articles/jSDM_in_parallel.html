<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running jSDM in parallel • jSDM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running jSDM in parallel">
<meta property="og:description" content="jSDM">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jSDM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/jSDM.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Change log</a>
</li>
<li>
  <a></a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ghislainv/jSDM">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="jSDM_in_parallel_files/jquery-1.11.3/jquery.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="jSDM_in_parallel_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="jSDM_in_parallel_files/bootstrap-3.3.5/js/bootstrap.min.js"></script><script src="jSDM_in_parallel_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script><script src="jSDM_in_parallel_files/bootstrap-3.3.5/shim/respond.min.js"></script><style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="jSDM_in_parallel_files/navigation-1.1/tabsets.js"></script><script src="jSDM_in_parallel_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running jSDM in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ghislainv/jSDM/blob/master/vignettes/jSDM_in_parallel.Rmd"><code>vignettes/jSDM_in_parallel.Rmd</code></a></small>
      <div class="hidden name"><code>jSDM_in_parallel.Rmd</code></div>

    </div>

    
    
<div id="generating-data-for-a-hierarchical-gaussian-linear-regression" class="section level1">
<h1 class="hasAnchor">
<a href="#generating-data-for-a-hierarchical-gaussian-linear-regression" class="anchor"></a><span class="header-section-number">1</span> Generating data for a Hierarchical Gaussian Linear Regression</h1>
<div id="binomial-model-for-presence-absence-data" class="section level2">
<h2 class="hasAnchor">
<a href="#binomial-model-for-presence-absence-data" class="anchor"></a><span class="header-section-number">1.1</span> Binomial model for presence-absence data</h2>
<p>We consider a latent variable model (LVM) to account for species co-occurrence on all sites <span class="citation">(Warton <em>et al.</em> <a href="#ref-Warton2015" role="doc-biblioref">2015</a>)</span>.</p>
<p><span class="math display">\[y_{ij} \sim \mathcal{B}ernoulli(\theta_{ij})\]</span></p>
<p><span class="math display">\[ \mathrm{g}(\theta_{ij}) =\alpha_i + X_i\beta_j + W_i\lambda_j \]</span></p>
<ul>
<li>
<span class="math inline">\(\mathrm{g}(\cdot)\)</span>: Link function probit.</li>
<li>
<span class="math inline">\(\alpha_i\)</span>: Site random effect with <span class="math inline">\(\alpha_i \sim \mathcal{N}(0, V_{\alpha})\)</span>. Corresponds to a mean suitability for site <span class="math inline">\(i\)</span>.</li>
<li>
<span class="math inline">\(X_i\)</span>: Vector of explanatory variables for site <span class="math inline">\(i\)</span> (including intercept).</li>
<li>
<span class="math inline">\(\beta_j\)</span>: Effects of the explanatory variables on the probability of presence of species <span class="math inline">\(j\)</span>.</li>
<li>
<span class="math inline">\(W_i\)</span>: Vector of random latent variables for site <span class="math inline">\(i\)</span>. <span class="math inline">\(W_i \sim N(0, 1)\)</span>. The number of latent variables must be fixed by the user (default to 2).</li>
<li>
<span class="math inline">\(\lambda_j\)</span>: Effects of the latent variables on the probability of presence of species <span class="math inline">\(j\)</span>. Also known as “factor loadings” <span class="citation">(Warton <em>et al.</em> <a href="#ref-Warton2015" role="doc-biblioref">2015</a>)</span>.</li>
</ul>
<p>This model is equivalent to a multivariate GLMM <span class="math inline">\(\mathrm{g}(\theta_{ij}) =\alpha_i + X_i.\beta_j + u_{ij}\)</span>, where <span class="math inline">\(u_{ij} \sim \mathcal{N}(0, \Sigma)\)</span> with the constraint that the variance-covariance matrix <span class="math inline">\(\Sigma = \Lambda \Lambda^{\prime}\)</span>, where <span class="math inline">\(\Lambda\)</span> is the full matrix of factor loadings, with the <span class="math inline">\(\lambda_j\)</span> as its columns.</p>
</div>
<div id="data-set-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-set-simulation" class="anchor"></a><span class="header-section-number">1.2</span> Data-set simulation</h2>
<p>We generate presence-absence data following this generalized multivariate linear model with a probit link function, which includes latent variables and random site effect.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#=================</span>
<span class="co">#== load libraries</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ecology.ghislainv.fr/jSDM">jSDM</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#==================</span>
<span class="co">#== Data simulation</span>

<span class="co">#= Number of sites</span>
<span class="va">nsite</span> <span class="op">&lt;-</span> <span class="fl">300</span>

<span class="co">#= Set seed for repeatability</span>
<span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">123</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span>

<span class="co">#= Number of species</span>
<span class="va">nsp</span><span class="op">&lt;-</span> <span class="fl">100</span>

<span class="co">#= Number of latent variables</span>
<span class="va">n_latent</span> <span class="op">&lt;-</span> <span class="fl">2</span>

<span class="co">#= Ecological process (suitability)</span>
<span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsite</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsite</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">nsite</span><span class="op">)</span>,<span class="va">x1</span>,<span class="va">x2</span><span class="op">)</span>
<span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
<span class="co">#= Latent variables W</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsite</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsite</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span> <span class="op">(</span><span class="va">X</span>,<span class="va">W</span><span class="op">)</span>
<span class="co">#= Fixed species effect beta </span>
<span class="va">beta.target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsp</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,
                        byrow<span class="op">=</span><span class="cn">TRUE</span>, nrow<span class="op">=</span><span class="va">nsp</span><span class="op">)</span><span class="op">)</span>
<span class="co">#= Factor loading lambda  </span>
<span class="va">l.zero</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">l.diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">l.other</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">nsp</span><span class="op">*</span><span class="va">n_latent</span><span class="op">-</span><span class="fl">3</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">lambda.target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">l.diag</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">l.zero</span>,
                            <span class="va">l.other</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">l.diag</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="va">l.other</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">TRUE</span>, nrow<span class="op">=</span><span class="va">nsp</span><span class="op">)</span><span class="op">)</span>
<span class="va">param.target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">beta.target</span>,<span class="va">lambda.target</span><span class="op">)</span>
<span class="co">#= Variance of random site effect </span>
<span class="va">V_alpha.target</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>
<span class="co">#= Random site effect </span>
<span class="va">alpha.target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsite</span>,<span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">V_alpha.target</span><span class="op">)</span><span class="op">)</span>
<span class="co">#= probit(theta)</span>
<span class="va">probit_theta</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">%*%</span><span class="va">beta.target</span> <span class="op">+</span> <span class="va">W</span><span class="op">%*%</span><span class="va">lambda.target</span> <span class="op">+</span> <span class="va">alpha.target</span>
<span class="co"># Latent variable Z </span>
<span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nsp</span><span class="op">*</span><span class="va">nsite</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="va">nsite</span>,<span class="va">nsp</span><span class="op">)</span>
<span class="va">Z_true</span> <span class="op">&lt;-</span> <span class="va">probit_theta</span> <span class="op">+</span> <span class="va">e</span>
<span class="co"># Presence-absence matrix Y</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span> <span class="op">(</span><span class="cn">NA</span>, <span class="va">nsite</span>,<span class="va">nsp</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsite</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nsp</span><span class="op">)</span><span class="op">{</span>
    <span class="kw">if</span> <span class="op">(</span> <span class="va">Z_true</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">}</span>
    <span class="kw">else</span> <span class="op">{</span><span class="va">Y</span><span class="op">[</span><span class="va">i</span>,<span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Species"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">nsp</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z_true</span>, <span class="va">alpha.target</span>, <span class="va">V_alpha.target</span>, <span class="va">beta.target</span>, <span class="va">probit_theta</span>,
     <span class="va">X</span>, <span class="va">lambda.target</span>, <span class="va">np</span> , <span class="va">nsite</span>, <span class="va">nsp</span>, <span class="va">n_latent</span>, <span class="va">W</span>, file<span class="op">=</span><span class="st">"jSDM_in_parallel_files/sim_data.rda"</span><span class="op">)</span></code></pre></div>
<p>We look at the number of observations per site.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"jSDM_in_parallel_files/sim_data.rda"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
<span class="co">#&gt;      Species1 Species2 Species3 Species4 Species5 Species6 Species7 Species8</span>
<span class="co">#&gt; [1,]        0        0        0        0        0        0        0        1</span>
<span class="co">#&gt; [2,]        1        0        1        1        0        0        1        1</span>
<span class="co">#&gt; [3,]        1        1        0        0        0        0        0        0</span>
<span class="co">#&gt; [4,]        1        1        0        0        0        1        0        1</span>
<span class="co">#&gt; [5,]        0        1        0        1        1        1        0        0</span>
<span class="co">#&gt; [6,]        1        1        1        1        0        0        1        0</span>
<span class="co">#&gt;      Species9 Species10 Species11 Species12 Species13 Species14 Species15</span>
<span class="co">#&gt; [1,]        1         0         1         0         0         0         0</span>
<span class="co">#&gt; [2,]        1         0         1         1         0         1         0</span>
<span class="co">#&gt; [3,]        1         1         1         0         1         1         0</span>
<span class="co">#&gt; [4,]        0         1         1         1         0         1         0</span>
<span class="co">#&gt; [5,]        0         1         1         1         1         1         0</span>
<span class="co">#&gt; [6,]        0         0         0         1         0         0         0</span>
<span class="co">#&gt;      Species16 Species17 Species18 Species19 Species20 Species21 Species22</span>
<span class="co">#&gt; [1,]         1         0         0         0         0         0         0</span>
<span class="co">#&gt; [2,]         1         0         0         1         0         0         1</span>
<span class="co">#&gt; [3,]         1         0         0         1         0         0         0</span>
<span class="co">#&gt; [4,]         1         0         0         1         1         0         0</span>
<span class="co">#&gt; [5,]         0         1         0         1         1         0         0</span>
<span class="co">#&gt; [6,]         0         0         1         1         1         1         1</span>
<span class="co">#&gt;      Species23 Species24 Species25 Species26 Species27 Species28 Species29</span>
<span class="co">#&gt; [1,]         0         1         0         0         1         1         1</span>
<span class="co">#&gt; [2,]         0         1         1         1         1         0         1</span>
<span class="co">#&gt; [3,]         0         0         0         1         0         0         0</span>
<span class="co">#&gt; [4,]         1         0         0         1         1         1         0</span>
<span class="co">#&gt; [5,]         0         1         0         1         1         0         0</span>
<span class="co">#&gt; [6,]         0         0         1         0         1         1         1</span>
<span class="co">#&gt;      Species30 Species31 Species32 Species33 Species34 Species35 Species36</span>
<span class="co">#&gt; [1,]         1         0         0         1         0         0         0</span>
<span class="co">#&gt; [2,]         1         1         1         1         0         0         0</span>
<span class="co">#&gt; [3,]         0         1         1         0         0         0         0</span>
<span class="co">#&gt; [4,]         0         1         1         1         1         1         0</span>
<span class="co">#&gt; [5,]         1         0         0         1         0         1         0</span>
<span class="co">#&gt; [6,]         1         0         1         1         1         1         1</span>
<span class="co">#&gt;      Species37 Species38 Species39 Species40 Species41 Species42 Species43</span>
<span class="co">#&gt; [1,]         0         0         0         0         0         1         0</span>
<span class="co">#&gt; [2,]         1         1         0         1         1         0         0</span>
<span class="co">#&gt; [3,]         1         0         1         1         0         0         0</span>
<span class="co">#&gt; [4,]         1         0         1         1         1         0         0</span>
<span class="co">#&gt; [5,]         0         0         0         0         0         0         1</span>
<span class="co">#&gt; [6,]         1         0         1         1         1         1         0</span>
<span class="co">#&gt;      Species44 Species45 Species46 Species47 Species48 Species49 Species50</span>
<span class="co">#&gt; [1,]         0         0         0         0         0         0         1</span>
<span class="co">#&gt; [2,]         1         0         0         1         0         1         1</span>
<span class="co">#&gt; [3,]         1         0         0         0         0         1         1</span>
<span class="co">#&gt; [4,]         1         1         0         1         0         1         0</span>
<span class="co">#&gt; [5,]         1         1         0         1         0         1         1</span>
<span class="co">#&gt; [6,]         1         1         0         1         1         1         1</span>
<span class="co">#&gt;      Species51 Species52 Species53 Species54 Species55 Species56 Species57</span>
<span class="co">#&gt; [1,]         1         0         0         0         1         1         0</span>
<span class="co">#&gt; [2,]         0         0         0         0         0         0         1</span>
<span class="co">#&gt; [3,]         0         1         1         0         0         1         1</span>
<span class="co">#&gt; [4,]         0         0         1         0         1         1         1</span>
<span class="co">#&gt; [5,]         1         0         1         0         1         1         0</span>
<span class="co">#&gt; [6,]         1         1         1         0         1         0         1</span>
<span class="co">#&gt;      Species58 Species59 Species60 Species61 Species62 Species63 Species64</span>
<span class="co">#&gt; [1,]         0         1         0         0         0         1         0</span>
<span class="co">#&gt; [2,]         0         1         0         0         0         0         0</span>
<span class="co">#&gt; [3,]         0         0         0         0         0         0         0</span>
<span class="co">#&gt; [4,]         0         0         0         0         0         0         1</span>
<span class="co">#&gt; [5,]         1         0         0         0         0         1         0</span>
<span class="co">#&gt; [6,]         1         0         1         0         0         1         0</span>
<span class="co">#&gt;      Species65 Species66 Species67 Species68 Species69 Species70 Species71</span>
<span class="co">#&gt; [1,]         0         0         0         1         0         0         1</span>
<span class="co">#&gt; [2,]         1         1         1         0         1         0         0</span>
<span class="co">#&gt; [3,]         1         0         1         0         0         0         0</span>
<span class="co">#&gt; [4,]         1         1         1         0         0         1         1</span>
<span class="co">#&gt; [5,]         1         1         1         1         0         1         1</span>
<span class="co">#&gt; [6,]         0         1         1         0         0         0         0</span>
<span class="co">#&gt;      Species72 Species73 Species74 Species75 Species76 Species77 Species78</span>
<span class="co">#&gt; [1,]         0         0         1         0         0         1         0</span>
<span class="co">#&gt; [2,]         0         0         1         1         0         0         0</span>
<span class="co">#&gt; [3,]         0         0         1         0         1         0         0</span>
<span class="co">#&gt; [4,]         0         0         1         1         1         1         1</span>
<span class="co">#&gt; [5,]         0         0         1         0         0         1         0</span>
<span class="co">#&gt; [6,]         1         1         1         1         0         0         0</span>
<span class="co">#&gt;      Species79 Species80 Species81 Species82 Species83 Species84 Species85</span>
<span class="co">#&gt; [1,]         0         0         0         1         0         0         1</span>
<span class="co">#&gt; [2,]         0         1         0         1         1         1         1</span>
<span class="co">#&gt; [3,]         0         1         1         1         1         0         0</span>
<span class="co">#&gt; [4,]         0         0         1         0         1         0         0</span>
<span class="co">#&gt; [5,]         0         0         1         0         1         1         1</span>
<span class="co">#&gt; [6,]         0         1         1         1         0         1         0</span>
<span class="co">#&gt;      Species86 Species87 Species88 Species89 Species90 Species91 Species92</span>
<span class="co">#&gt; [1,]         1         0         0         0         0         1         1</span>
<span class="co">#&gt; [2,]         0         1         0         0         1         0         0</span>
<span class="co">#&gt; [3,]         1         1         1         1         1         0         0</span>
<span class="co">#&gt; [4,]         1         0         1         0         1         0         1</span>
<span class="co">#&gt; [5,]         1         0         0         0         0         0         1</span>
<span class="co">#&gt; [6,]         1         1         1         1         0         0         0</span>
<span class="co">#&gt;      Species93 Species94 Species95 Species96 Species97 Species98 Species99</span>
<span class="co">#&gt; [1,]         0         1         0         1         1         0         1</span>
<span class="co">#&gt; [2,]         1         0         1         0         1         1         1</span>
<span class="co">#&gt; [3,]         1         0         1         0         1         0         0</span>
<span class="co">#&gt; [4,]         0         0         1         0         0         0         1</span>
<span class="co">#&gt; [5,]         0         1         1         1         1         0         0</span>
<span class="co">#&gt; [6,]         1         1         1         0         1         1         1</span>
<span class="co">#&gt;      Species100</span>
<span class="co">#&gt; [1,]          1</span>
<span class="co">#&gt; [2,]          0</span>
<span class="co">#&gt; [3,]          1</span>
<span class="co">#&gt; [4,]          0</span>
<span class="co">#&gt; [5,]          1</span>
<span class="co">#&gt; [6,]          1</span>
<span class="co"># Number of observations per site</span>
<span class="va">nobs_site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Y</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span>
<span class="va">nobs_site</span>
<span class="co">#&gt;   [1] 31 49 39 51 49 61 56 37 54 59 65 50 38 32 79 53 32 27 43 56 44 75 23 84 61</span>
<span class="co">#&gt;  [26] 51 59 31 65 66 27 30 45 40 29 44 41 16 55 33 21 31 39 69 37 57 35 47 28 29</span>
<span class="co">#&gt;  [51] 53 70 50 50 50 67 65  9 28 48 31 63 50 66 71 86 37 32 42 29 71 25 27 59 64</span>
<span class="co">#&gt;  [76] 60 35 26 63 65 82 28 19 62 77 43 68 40 77 52 56 36 40 36 43 39 54 32 56 33</span>
<span class="co">#&gt; [101] 32 72 57 49 30 38 28 57 89 73 62 46 74 77 44 76 64 35 33 43 55 37 44 39 70</span>
<span class="co">#&gt; [126] 51 60 34 34 24 59 41 44 61 59 32 21 66 28 31 65 77 46 59 45 58 53 76 58 53</span>
<span class="co">#&gt; [151] 31 47 43 42 54 54 22 65 46 46 16 25 56 56 60 50 45 48 55 55 50 53 75 61 55</span>
<span class="co">#&gt; [176] 61 15 43 27 67 53 34 61 71 40 38 37 35 61 40 56 34 59 45 27 38 28 28 31 19</span>
<span class="co">#&gt; [201] 70 36 51 54 55 49 60 64 35 24 54 50 43 47 76 52 21 52 38 50 52 75 45 64 64</span>
<span class="co">#&gt; [226] 55 25 43 54 48 53 45 69 42 50 63 53 81 73 79 57 44 30 34 34 60 45 50 72 61</span>
<span class="co">#&gt; [251] 48 35 41 28 56 36 53 69 57 47 37 55 48 29 48 59 49 62 34 88 26 60 55 31 44</span>
<span class="co">#&gt; [276] 44 38 45 42 56 28 52 31 76 44 33 44 57 57 38 65 59 56 46 62 51 23 64 68 60</span>
<span class="co"># Number of observations per species</span>
<span class="va">nobs_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Y</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span>
<span class="va">nobs_sp</span>
<span class="co">#&gt;   Species1   Species2   Species3   Species4   Species5   Species6   Species7 </span>
<span class="co">#&gt;        189        197         99        144        109         85        165 </span>
<span class="co">#&gt;   Species8   Species9  Species10  Species11  Species12  Species13  Species14 </span>
<span class="co">#&gt;        193        162        194        188        188        101        192 </span>
<span class="co">#&gt;  Species15  Species16  Species17  Species18  Species19  Species20  Species21 </span>
<span class="co">#&gt;        100        186        118        114        191        100        108 </span>
<span class="co">#&gt;  Species22  Species23  Species24  Species25  Species26  Species27  Species28 </span>
<span class="co">#&gt;        101         92         91        123        132        183        115 </span>
<span class="co">#&gt;  Species29  Species30  Species31  Species32  Species33  Species34  Species35 </span>
<span class="co">#&gt;        199        157        192        214        222        100        187 </span>
<span class="co">#&gt;  Species36  Species37  Species38  Species39  Species40  Species41  Species42 </span>
<span class="co">#&gt;        134        210        112        182        159        183        107 </span>
<span class="co">#&gt;  Species43  Species44  Species45  Species46  Species47  Species48  Species49 </span>
<span class="co">#&gt;        119        212        165         85        194         98        170 </span>
<span class="co">#&gt;  Species50  Species51  Species52  Species53  Species54  Species55  Species56 </span>
<span class="co">#&gt;        213        151        126        141         95        141        176 </span>
<span class="co">#&gt;  Species57  Species58  Species59  Species60  Species61  Species62  Species63 </span>
<span class="co">#&gt;         77        156        104        100        184         84        200 </span>
<span class="co">#&gt;  Species64  Species65  Species66  Species67  Species68  Species69  Species70 </span>
<span class="co">#&gt;        122        157        203        209        161         80        107 </span>
<span class="co">#&gt;  Species71  Species72  Species73  Species74  Species75  Species76  Species77 </span>
<span class="co">#&gt;        177        129         86        198        125        156        112 </span>
<span class="co">#&gt;  Species78  Species79  Species80  Species81  Species82  Species83  Species84 </span>
<span class="co">#&gt;        183         89        156        120        113        234         99 </span>
<span class="co">#&gt;  Species85  Species86  Species87  Species88  Species89  Species90  Species91 </span>
<span class="co">#&gt;        192        165        104        117        128        145         89 </span>
<span class="co">#&gt;  Species92  Species93  Species94  Species95  Species96  Species97  Species98 </span>
<span class="co">#&gt;        108        127        144        205        171         99        126 </span>
<span class="co">#&gt;  Species99 Species100 </span>
<span class="co">#&gt;        160        185</span>

<span class="co"># Remove species with less than 5 presences</span>
<span class="va">rare_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">Y</span>, <span class="fl">2</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> 
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">rare_sp</span><span class="op">)</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">{</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">Y</span><span class="op">[</span>, <span class="op">-</span><span class="va">rare_sp</span><span class="op">]</span>
  <span class="va">probit_theta</span> <span class="op">&lt;-</span> <span class="va">probit_theta</span><span class="op">[</span>, <span class="op">-</span><span class="va">rare_sp</span><span class="op">]</span>
  <span class="va">Z_true</span> <span class="op">&lt;-</span> <span class="va">Z_true</span><span class="op">[</span>, <span class="op">-</span><span class="va">rare_sp</span><span class="op">]</span> 
  <span class="va">nsp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
  <span class="va">nsp</span>
  <span class="va">nsite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span>
  <span class="va">nsite</span>
<span class="op">}</span></code></pre></div>
</div>
</div>
<div id="fitting-joint-species-distribution-models-in-parallel" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-joint-species-distribution-models-in-parallel" class="anchor"></a><span class="header-section-number">2</span> Fitting joint Species Distribution Models in parallel</h1>
<p>We simulate in parallel two Monte-Carlo Markov chains (MCMC) of parameters values for this binomial model, using the R packages <code>doParallel</code> and <code>foreach</code> in a first time and <code>snow</code> and <code>snowfall</code> in a second time.</p>
<div id="using-doparallel-and-foreach" class="section level2">
<h2 class="hasAnchor">
<a href="#using-doparallel-and-foreach" class="anchor"></a><span class="header-section-number">2.1</span> Using <code>doParallel</code> and <code>foreach</code>
</h2>
<p>We estimate the model parameters with the function <code><a href="../reference/jSDM_binomial_probit_block.html">jSDM_binomial_probit_block()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="co">## Make a cluster for parallel MCMCs</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">ncores</span> <span class="op">&lt;-</span> <span class="va">nchains</span> <span class="co">## One core for each MCMC chains</span>
<span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span>

<span class="co"># Number of latent variables</span>
<span class="va">n_latent</span> <span class="op">&lt;-</span> <span class="fl">2</span>

<span class="co"># Starting parameters </span>
<span class="va">lambda_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">beta_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>
<span class="va">W_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>,<span class="op">-</span><span class="fl">0.1</span><span class="op">)</span>
<span class="va">alpha_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>
<span class="va">V_alpha_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span>
<span class="co">#formatting of starting parameters</span>
<span class="co">#and constraints on lambda generated by the function </span>
<span class="co"># Seeds</span>
<span class="va">seed_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1234</span>, <span class="fl">4321</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Model</span>
<span class="va">mod_probit_1</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span> <span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="op">{</span>
    <span class="co"># Infering model parameters</span>
    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jSDM_binomial_probit_block.html">jSDM_binomial_probit_block</a></span><span class="op">(</span>
      <span class="co"># Iterations</span>
      burnin<span class="op">=</span><span class="fl">10000</span>, mcmc<span class="op">=</span><span class="fl">10000</span>, thin<span class="op">=</span><span class="fl">10</span>,
      <span class="co"># Data</span>
      presence_site_sp<span class="op">=</span><span class="va">Y</span>,
      site_data <span class="op">=</span> <span class="va">X</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>,
      site_suitability <span class="op">=</span> <span class="op">~</span><span class="va">.</span>,
      <span class="co"># Model specification </span>
      n_latent<span class="op">=</span><span class="va">n_latent</span>,
      site_effect<span class="op">=</span><span class="st">"random"</span>,
      <span class="co"># Priors</span>
      V_beta <span class="op">=</span> <span class="fl">1</span>,
      mu_beta <span class="op">=</span> <span class="fl">0</span>,
      mu_lambda <span class="op">=</span> <span class="fl">0</span>,
      V_lambda<span class="op">=</span> <span class="fl">1</span>,
      shape<span class="op">=</span><span class="fl">0.5</span>, 
      rate<span class="op">=</span><span class="fl">0.0005</span>,
      <span class="co"># Starting values</span>
      beta_start <span class="op">=</span> <span class="va">beta_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
      lambda_start <span class="op">=</span> <span class="va">lambda_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
      W_start<span class="op">=</span><span class="va">W_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
      alpha_start <span class="op">=</span> <span class="va">alpha_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
      V_alpha <span class="op">=</span> <span class="va">V_alpha_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
      <span class="co"># Other</span>
      seed <span class="op">=</span> <span class="va">seed_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
      verbose <span class="op">=</span> <span class="fl">1</span>
    <span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
  <span class="op">}</span>
<span class="co"># Stop cluster</span>
<span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span></code></pre></div>
</div>
<div id="using-snow-and-snowfall" class="section level2">
<h2 class="hasAnchor">
<a href="#using-snow-and-snowfall" class="anchor"></a><span class="header-section-number">2.2</span> Using <code>snow</code> and <code>snowfall</code>
</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## load libraries</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">snow</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">snowfall</span><span class="op">)</span>

<span class="co">## Setting the number of CPUs to be 2</span>
<span class="fu"><a href="https://rdrr.io/pkg/snowfall/man/snowfall-b-init.html">sfInit</a></span><span class="op">(</span>parallel<span class="op">=</span><span class="cn">TRUE</span>, cpus<span class="op">=</span><span class="fl">2</span><span class="op">)</span>

<span class="co">## Assigning the jSDM library to each CPU</span>
<span class="fu"><a href="https://rdrr.io/pkg/snowfall/man/snowfall-d-tools.html">sfLibrary</a></span><span class="op">(</span><span class="va">jSDM</span><span class="op">)</span>

<span class="co"># Number of latent variables</span>
<span class="va">n_latent</span> <span class="op">&lt;-</span> <span class="fl">2</span>

<span class="co"># Starting parameters </span>
<span class="co"># formatting of starting parameters</span>
<span class="co"># and constraints on lambda generated by the function </span>
<span class="va">lambda_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>
<span class="va">beta_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span><span class="op">)</span>
<span class="va">W_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="op">-</span><span class="fl">0.2</span><span class="op">)</span>
<span class="va">alpha_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">V_alpha_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1.5</span><span class="op">)</span>

<span class="co"># Seeds</span>
<span class="va">seed_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">123</span>, <span class="fl">321</span><span class="op">)</span>

<span class="co"># list of data and starting parameters </span>
<span class="va">listData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>, X<span class="op">=</span><span class="va">X</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">beta_start</span>, <span class="va">lambda_start</span>, <span class="va">W_start</span>, <span class="va">alpha_start</span>, <span class="va">V_alpha_start</span>, <span class="va">seed_mcmc</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Defining the function that will run MCMC on each CPU</span>
<span class="co"># Arguments:</span>
<span class="co"># i - will be 1 or 2</span>
<span class="va">mod.MCMChregress</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">i</span>,<span class="va">listData</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># data</span>
  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="va">X</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  <span class="va">beta_start</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>
  <span class="va">lambda_start</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>
  <span class="va">W_start</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span>
  <span class="va">alpha_start</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span>
  <span class="va">V_alpha_start</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span>
  <span class="va">seed_mcmc</span> <span class="op">&lt;-</span> <span class="va">listData</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span>
  <span class="co"># Infering model parameters</span>
  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/jSDM_binomial_probit_block.html">jSDM_binomial_probit_block</a></span><span class="op">(</span>
    <span class="co"># Iterations</span>
    burnin<span class="op">=</span><span class="fl">10000</span>, mcmc<span class="op">=</span><span class="fl">10000</span>, thin<span class="op">=</span><span class="fl">10</span>,
    <span class="co"># Data</span>
    presence_site_sp<span class="op">=</span><span class="va">Y</span>,
    site_data <span class="op">=</span> <span class="va">X</span>,
    site_suitability <span class="op">=</span> <span class="op">~</span><span class="va">.</span>,
    <span class="co"># Model specification </span>
    n_latent<span class="op">=</span><span class="fl">2</span>,
    site_effect<span class="op">=</span><span class="st">"random"</span>,
    <span class="co"># Priors</span>
    V_beta <span class="op">=</span> <span class="fl">1</span>,
    mu_beta <span class="op">=</span> <span class="fl">0</span>,
    mu_lambda <span class="op">=</span> <span class="fl">0</span>,
    V_lambda<span class="op">=</span> <span class="fl">1</span>,
    shape<span class="op">=</span><span class="fl">0.5</span>, 
    rate<span class="op">=</span><span class="fl">0.0005</span>,
    <span class="co"># Starting values</span>
    beta_start <span class="op">=</span> <span class="va">beta_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    lambda_start <span class="op">=</span> <span class="va">lambda_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    W_start <span class="op">=</span> <span class="va">W_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    alpha_start <span class="op">=</span> <span class="va">alpha_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    V_alpha <span class="op">=</span> <span class="va">V_alpha_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    <span class="co"># Other</span>
    seed <span class="op">=</span> <span class="va">seed_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    verbose <span class="op">=</span> <span class="fl">1</span>
  <span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
<span class="op">}</span><span class="co"># Starting parameters </span>

<span class="co">## Calling the sfLapply function that will run on each of the CPUs</span>
<span class="va">mod_probit_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/snowfall/man/snowfall-c-calculation.html">sfLapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, fun<span class="op">=</span><span class="va">mod.MCMChregress</span>, listData<span class="op">=</span><span class="va">listData</span><span class="op">)</span>

<span class="co">## Stop cluster</span>
<span class="fu"><a href="https://rdrr.io/pkg/snowfall/man/snowfall-b-init.html">sfStop</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># Output</span>
<span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mod_probit_1</span>, <span class="va">mod_probit_2</span><span class="op">)</span><span class="op">)</span>
<span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod_probit_1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">str_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html">capture.output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">mod</span>, max.level <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">n_chains</span>, <span class="va">str_mod</span>, file<span class="op">=</span><span class="st">"jSDM_in_parallel_files/output.rda"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"jSDM_in_parallel_files/output.rda"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"number of chains :"</span>, <span class="va">n_chains</span>,<span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; number of chains : 4</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"content of each chain :"</span>, <span class="va">str_mod</span>,<span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; content of each chain : List of 8</span>
<span class="co">#&gt;  $ mcmc.Deviance    : 'mcmc' num [1:1000, 1] 24686 24755 24811 24790 24750 ...</span>
<span class="co">#&gt;   ..- attr(*, "mcpar")= num [1:3] 10001 19991 10</span>
<span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;  $ mcmc.alpha       : 'mcmc' num [1:1000, 1:300] -0.694 -0.861 -0.494 -0.841 -0.35 ...</span>
<span class="co">#&gt;   ..- attr(*, "mcpar")= num [1:3] 10001 19991 10</span>
<span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;  $ mcmc.V_alpha     : 'mcmc' num [1:1000, 1] 0.407 0.377 0.482 0.439 0.439 ...</span>
<span class="co">#&gt;   ..- attr(*, "mcpar")= num [1:3] 10001 19991 10</span>
<span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">#&gt;  $ mcmc.sp          :List of 100</span>
<span class="co">#&gt;  $ mcmc.latent      :List of 2</span>
<span class="co">#&gt;  $ Z_latent         : num [1:300, 1:100] -0.683 1.232 1.202 1.029 -0.603 ...</span>
<span class="co">#&gt;  $ probit_theta_pred: num [1:300, 1:100] 0.463 0.885 0.833 0.442 0.72 ...</span>
<span class="co">#&gt;  $ model_spec       :List of 24</span>
<span class="co">#&gt;  - attr(*, "class")= chr "jSDM"</span></code></pre></div>
</div>
</div>
<div id="evaluation-of-mcmc-convergence" class="section level1">
<h1 class="hasAnchor">
<a href="#evaluation-of-mcmc-convergence" class="anchor"></a><span class="header-section-number">3</span> Evaluation of MCMC convergence</h1>
<p>We evaluate the convergence of the MCMC output in which four parallel chains are run with starting values that are overdispersed relative to the posterior distribution.
Convergence is diagnosed when the four chains have ‘forgotten’ their initial values, and the output from all chains is indistinguishable.
If the convergence diagnostic gives values of potential scale reduction factor or psrf
substantially above 1, its indicates lack of convergence.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span>
<span class="va">arr2mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html">mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">mod_probit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mod_probit_1</span>,<span class="va">mod_probit_2</span><span class="op">)</span>
<span class="co"># MCMC lists</span>
<span class="va">mcmc_list_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.V_alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.latent"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_centered_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span>, <span class="va">scale</span>, scale<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,<span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_deviance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.Deviance"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.sp"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_centered_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"lambda"</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"sp_1.lambda_2"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, invert<span class="op">=</span><span class="cn">TRUE</span>, value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, <span class="va">scale</span>, scale<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,<span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_deviance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.Deviance"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">nsamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co"># psrf gelman indice </span>
<span class="va">psrf_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">)</span><span class="op">$</span><span class="va">mpsrf</span>
<span class="va">psrf_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span>
<span class="va">psrf_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"beta"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">mpsrf</span>
<span class="va">psrf_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_centered_lambda</span><span class="op">)</span><span class="op">$</span><span class="va">mpsrf</span>
<span class="va">psrf_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_centered_lv</span><span class="op">)</span><span class="op">$</span><span class="va">mpsrf</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">psrf_lambda</span>, <span class="va">psrf_lv</span>, <span class="va">psrf_alpha</span>, <span class="va">psrf_V_alpha</span>, <span class="va">psrf_beta</span>,
     file<span class="op">=</span><span class="st">"jSDM_in_parallel_files/psrf.rda"</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; psrf centered latent variables: 1.239745
#&gt; psrf centered lambda: 1.12503
#&gt; psrf alpha: 1.309279
#&gt; psrf V_alpha: 0.9995559
#&gt; psrf beta: 1.190432</code></pre>
</div>
<div id="representation-of-results" class="section level1">
<h1 class="hasAnchor">
<a href="#representation-of-results" class="anchor"></a><span class="header-section-number">4</span> Representation of results</h1>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Plot trace and posterior distributions </span>
<span class="co"># for two first species</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="va">n_latent</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co"># for two first sites </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="va">nsite</span><span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/traceplot.html">traceplot</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span>
<span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/densplot.html">densplot</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">V_alpha.target</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend<span class="op">=</span><span class="st">"V_alpha.target"</span>,
       lwd<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span>, cex<span class="op">=</span><span class="fl">0.6</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co"># Deviance </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mcmc_list_deviance</span><span class="op">)</span></code></pre></div>
<p><img src="jSDM_in_parallel_files/figure-html/est-probit-1.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-2.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-3.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-4.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-5.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-6.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-7.png" width="800" style="display: block; margin: auto;"></p>
</div>
<div id="accuracy-of-predictions" class="section level1">
<h1 class="hasAnchor">
<a href="#accuracy-of-predictions" class="anchor"></a><span class="header-section-number">5</span> Accuracy of predictions</h1>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Predictive posterior mean for each observation</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">)</span>
<span class="co"># Species effects beta and factor loadings lambda</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.sp</span>,<span class="va">colMeans</span><span class="op">)</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">nsp</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">beta.target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">np</span><span class="op">]</span>,
         main<span class="op">=</span><span class="st">"species effect beta"</span>,
         xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">else</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">beta.target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">np</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.sp</span>,<span class="va">colMeans</span><span class="op">)</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">nsp</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">lambda.target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="va">n_latent</span><span class="op">)</span><span class="op">]</span>,
         main<span class="op">=</span><span class="st">"factor loadings lambda"</span>,
         xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">lambda.target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="va">n_latent</span><span class="op">)</span><span class="op">]</span>,
           col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="co">## W latent variables</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">mean_W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">nsite</span>,<span class="va">n_latent</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_latent</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
    <span class="va">mean_W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.latent</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"lv_"</span>,<span class="va">l</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="st">"Mean"</span><span class="op">]</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>, <span class="va">mean_W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>,
           main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Latent variable W_"</span>, <span class="va">l</span><span class="op">)</span>,
           xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span>
      <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="kw">else</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>, <span class="va">mean_W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>,col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">#= W.lambda</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">W</span><span class="op">%*%</span><span class="va">lambda.target</span>,<span class="va">mean_W</span><span class="op">%*%</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="va">n_latent</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
         main <span class="op">=</span> <span class="st">"W.lambda"</span>,
         xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw">else</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">W</span><span class="op">%*%</span><span class="va">lambda.target</span>,<span class="va">mean_W</span><span class="op">%*%</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">np</span><span class="op">+</span><span class="va">n_latent</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
           ,col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">#= Random site effect alpha </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">alpha.target</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.alpha</span><span class="op">)</span>,
     xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span>, main<span class="op">=</span><span class="st">"site effect alpha"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">alpha.target</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.alpha</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>

<span class="co">#= Predictions </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">probit_theta</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_pred</span>,
     main<span class="op">=</span><span class="st">"probit(theta)"</span>,xlab<span class="op">=</span><span class="st">"obs"</span>,ylab<span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
  <span class="co">## probit(tetha)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">probit_theta</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_pred</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
<span class="co">## Z</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Z_true</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Z_latent</span>,
     main<span class="op">=</span><span class="st">"Z_latent"</span>, xlab<span class="op">=</span><span class="st">"obs"</span>, ylab<span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">Z_true</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Z_latent</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></code></pre></div>
<p><img src="jSDM_in_parallel_files/figure-html/obs-fitted-1.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/obs-fitted-2.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/obs-fitted-3.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/obs-fitted-4.png" width="800" style="display: block; margin: auto;"></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Warton2015">
<p>Warton, D.I., Blanchet, F.G., O’Hara, R.B., Ovaskainen, O., Taskinen, S., Walker, S.C. &amp; Hui, F.K.C. (2015) So many variables: Joint modeling in community ecology. <em>Trends in Ecology &amp; Evolution</em>, <strong>30</strong>, 766–779.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jeanne Clément, <a href="https://ecology.ghislainv.fr">Ghislain Vieilledent</a>, <a href="https://www.cirad.fr"><img src="https://ecology.ghislainv.fr/images/logos/logo-cirad.svg" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
