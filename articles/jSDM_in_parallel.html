<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running jSDM in parallel ‚Ä¢ jSDM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="‚Äùimage/svg+xml‚Äù" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running jSDM in parallel">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jSDM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/jSDM.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Change log</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ghislainv/jSDM" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Running jSDM in parallel</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ghislainv/jSDM/blob/master/vignettes/jSDM_in_parallel.Rmd" class="external-link"><code>vignettes/jSDM_in_parallel.Rmd</code></a></small>
      <div class="hidden name"><code>jSDM_in_parallel.Rmd</code></div>

    </div>

    
    
<div class="section level2" number="1">
<h2 id="generating-data-for-a-hierarchical-gaussian-linear-regression">
<span class="header-section-number">1</span> Generating data for a Hierarchical Gaussian Linear Regression<a class="anchor" aria-label="anchor" href="#generating-data-for-a-hierarchical-gaussian-linear-regression"></a>
</h2>
<div class="section level3" number="1.1">
<h3 id="binomial-model-for-presence-absence-data">
<span class="header-section-number">1.1</span> Binomial model for presence-absence data<a class="anchor" aria-label="anchor" href="#binomial-model-for-presence-absence-data"></a>
</h3>
<p>We consider a latent variable model (LVM) to account for species co-occurrence on all sites <span class="citation">(<a href="#ref-Warton2015">Warton <em>et al.</em> 2015</a>)</span>.</p>
<p><span class="math display">\[y_{ij} \sim \mathcal{B}ernoulli(\theta_{ij})\]</span></p>
<p><span class="math display">\[ \mathrm{g}(\theta_{ij}) =\alpha_i + X_i\beta_j + W_i\lambda_j \]</span></p>
<ul>
<li>
<span class="math inline">\(\mathrm{g}(\cdot)\)</span>: Link function probit.</li>
<li>
<span class="math inline">\(\alpha_i\)</span>: Site random effect with <span class="math inline">\(\alpha_i \sim \mathcal{N}(0, V_{\alpha})\)</span>. Corresponds to a mean suitability for site <span class="math inline">\(i\)</span>.</li>
<li>
<span class="math inline">\(X_i\)</span>: Vector of explanatory variables for site <span class="math inline">\(i\)</span> (including intercept).</li>
<li>
<span class="math inline">\(\beta_j\)</span>: Effects of the explanatory variables on the probability of presence of species <span class="math inline">\(j\)</span>.</li>
<li>
<span class="math inline">\(W_i\)</span>: Vector of random latent variables for site <span class="math inline">\(i\)</span>. <span class="math inline">\(W_i \sim N(0, 1)\)</span>. The number of latent variables must be fixed by the user (default to 2).</li>
<li>
<span class="math inline">\(\lambda_j\)</span>: Effects of the latent variables on the probability of presence of species <span class="math inline">\(j\)</span>. Also known as ‚Äúfactor loadings‚Äù <span class="citation">(<a href="#ref-Warton2015">Warton <em>et al.</em> 2015</a>)</span>.</li>
</ul>
<p>This model is equivalent to a multivariate GLMM <span class="math inline">\(\mathrm{g}(\theta_{ij}) =\alpha_i + X_i.\beta_j + u_{ij}\)</span>, where <span class="math inline">\(u_{ij} \sim \mathcal{N}(0, \Sigma)\)</span> with the constraint that the variance-covariance matrix <span class="math inline">\(\Sigma = \Lambda \Lambda^{\prime}\)</span>, where <span class="math inline">\(\Lambda\)</span> is the full matrix of factor loadings, with the <span class="math inline">\(\lambda_j\)</span> as its columns.</p>
</div>
<div class="section level3" number="1.2">
<h3 id="data-set-simulation">
<span class="header-section-number">1.2</span> Data-set simulation<a class="anchor" aria-label="anchor" href="#data-set-simulation"></a>
</h3>
<p>We generate presence-absence data following this generalized multivariate linear model with a probit link function, which includes latent variables and random site effect.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Variables</span></span>
<span><span class="va">n_species</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span><span class="va">n_sites</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">n_p</span> <span class="op">&lt;-</span> <span class="fl">3</span>  <span class="co"># Number of explanatory variables (including intercept)</span></span>
<span><span class="va">n_q</span> <span class="op">&lt;-</span> <span class="fl">2</span>  <span class="co"># Number of latent variables</span></span>
<span><span class="va">V_alpha_target</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>  <span class="co"># Variance of random site effects</span></span>
<span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">1234</span></span>
<span></span>
<span><span class="co"># Set seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Explanatory variables X</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sites</span> <span class="op">*</span> <span class="op">(</span><span class="va">n_p</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_sites</span>, ncol<span class="op">=</span><span class="op">(</span><span class="va">n_p</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_sites</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">n_p</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_sites</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Latent factors W</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sites</span> <span class="op">*</span> <span class="va">n_q</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_sites</span>, ncol<span class="op">=</span><span class="va">n_q</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fixed species effect beta </span></span>
<span><span class="va">beta_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_species</span> <span class="op">*</span> <span class="va">n_p</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_p</span>, ncol<span class="op">=</span><span class="va">n_species</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Factor loadings lambda  </span></span>
<span><span class="va">mat0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_species</span> <span class="op">*</span> <span class="va">n_q</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_q</span>, ncol<span class="op">=</span><span class="va">n_species</span><span class="op">)</span></span>
<span><span class="va">axis_imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">n_q</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span>  <span class="co">## Decreasing importance of the latent axis</span></span>
<span><span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">mat0</span> <span class="op">*</span> <span class="va">axis_imp</span></span>
<span><span class="va">lambda_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_q</span>, <span class="va">n_species</span><span class="op">)</span></span>
<span><span class="va">lambda_target</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">mat</span>, diag<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">mat</span>, diag<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># Large positive values on the diagonal</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">lambda_target</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">n_q</span><span class="op">:</span><span class="fl">1</span></span>
<span></span>
<span><span class="co"># Random site effect alpha</span></span>
<span><span class="va">alpha_target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sites</span>, mean<span class="op">=</span><span class="fl">0</span>, sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">V_alpha_target</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulation of response data with probit link</span></span>
<span><span class="co"># Latent variable Z</span></span>
<span><span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_species</span> <span class="op">*</span> <span class="va">n_sites</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">n_sites</span>, <span class="va">n_species</span><span class="op">)</span></span>
<span><span class="va">probit_theta</span> <span class="op">&lt;-</span> <span class="va">alpha_target</span> <span class="op">+</span> <span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">beta_target</span> <span class="op">+</span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">lambda_target</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">probit_theta</span> <span class="op">+</span> <span class="va">e</span></span>
<span><span class="co"># Presence-absence matrix Y</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_sites</span>, <span class="va">n_species</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"sp"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_species</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_sites</span>, sep<span class="op">=</span><span class="st">"_"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="2">
<h2 id="fitting-joint-species-distribution-models-in-parallel">
<span class="header-section-number">2</span> Fitting joint Species Distribution Models in parallel<a class="anchor" aria-label="anchor" href="#fitting-joint-species-distribution-models-in-parallel"></a>
</h2>
<p>We simulate in parallel two Monte-Carlo Markov chains (MCMC) of parameters values for this binomial model, using the R packages <code>doParallel</code> and <code>foreach</code> in a first step and the <code>snow</code> and <code>snowfall</code> packages in a second step.</p>
<div class="section level3" number="2.1">
<h3 id="using-doparallel-and-foreach">
<span class="header-section-number">2.1</span> Using <code>doParallel</code> and <code>foreach</code><a class="anchor" aria-label="anchor" href="#using-doparallel-and-foreach"></a>
</h3>
<p>We estimate the model parameters with the function <code><a href="../reference/jSDM_binomial_probit.html">jSDM_binomial_probit()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loading libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ecology.ghislainv.fr/jSDM/">jSDM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make a cluster for parallel MCMCs</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="va">n_chains</span> <span class="co">## One core for each MCMC chains</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Starting parameters </span></span>
<span><span class="va">alpha_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">beta_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">W_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">V_alpha_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Starting parameters for lambda</span></span>
<span><span class="co">## First option</span></span>
<span><span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n_chains</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_q</span><span class="op">*</span><span class="va">n_species</span>, min<span class="op">=</span><span class="op">-</span><span class="fl">0.1</span>, max<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_q</span><span class="op">)</span>, simplify<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">form_lambda_start</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">n_species</span>, <span class="va">n_q</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_q</span>, <span class="va">n_species</span><span class="op">)</span></span>
<span>  <span class="va">r</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">mat</span>, diag<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">mat</span>, diag<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">n_q</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, min<span class="op">=</span><span class="fl">1</span>, max<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">lambda_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mat</span>, <span class="va">form_lambda_start</span>, n_species<span class="op">=</span><span class="va">n_species</span>, n_q<span class="op">=</span><span class="va">n_q</span><span class="op">)</span></span>
<span><span class="co"># Second option</span></span>
<span><span class="co"># lambda_start &lt;- rep(0, n_chains)</span></span>
<span></span>
<span><span class="co"># Seeds</span></span>
<span><span class="va">seed_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1234</span>, <span class="fl">2134</span>, <span class="fl">3214</span>, <span class="fl">4231</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Model</span></span>
<span><span class="va">mod_probit_1</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span><span class="op">(</span>i<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span></span>
<span>    <span class="co"># Infering model parameters</span></span>
<span>    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">jSDM</span><span class="fu">::</span><span class="fu"><a href="../reference/jSDM_binomial_probit.html">jSDM_binomial_probit</a></span><span class="op">(</span></span>
<span>      <span class="co"># Iterations</span></span>
<span>      burnin<span class="op">=</span><span class="fl">1000</span>, mcmc<span class="op">=</span><span class="fl">1000</span>, thin<span class="op">=</span><span class="fl">1</span>,</span>
<span>      <span class="co"># Data</span></span>
<span>      presence_data<span class="op">=</span><span class="va">Y</span>,</span>
<span>      site_data<span class="op">=</span><span class="va">X</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>      site_formula<span class="op">=</span><span class="op">~</span><span class="va">.</span>,</span>
<span>      <span class="co"># Model specification </span></span>
<span>      n_latent<span class="op">=</span><span class="va">n_q</span>,</span>
<span>      site_effect<span class="op">=</span><span class="st">"random"</span>,</span>
<span>      <span class="co"># Priors</span></span>
<span>      mu_beta<span class="op">=</span><span class="fl">0</span>, V_beta<span class="op">=</span><span class="fl">1</span>,</span>
<span>      mu_lambda<span class="op">=</span><span class="fl">0</span>, V_lambda<span class="op">=</span><span class="fl">1</span>,</span>
<span>      shape_Valpha<span class="op">=</span><span class="fl">0.5</span>, </span>
<span>      rate_Valpha<span class="op">=</span><span class="fl">0.0005</span>,</span>
<span>      <span class="co"># Starting values</span></span>
<span>      beta_start<span class="op">=</span><span class="va">beta_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      lambda_start<span class="op">=</span><span class="va">lambda_start</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>      W_start<span class="op">=</span><span class="va">W_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      alpha_start<span class="op">=</span><span class="va">alpha_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      V_alpha<span class="op">=</span><span class="va">V_alpha_start</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      <span class="co"># Other</span></span>
<span>      seed<span class="op">=</span><span class="va">seed_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>      verbose <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="co"># Stop cluster</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Output content</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_probit_1</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod_probit_1</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">str_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">mod</span>, max.level <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">n_chains</span>, <span class="va">str_mod</span>, file<span class="op">=</span><span class="st">"jSDM_in_parallel_files/output.rda"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show output content</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"jSDM_in_parallel_files/output.rda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"number of chains :"</span>, <span class="va">n_chains</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; number of chains : 4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"content of each chain :"</span>, <span class="va">str_mod</span>,<span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; content of each chain : List of 9</span></span>
<span><span class="co">#&gt;  $ mcmc.Deviance      : 'mcmc' num [1:1000, 1] 11892 11903 11993 11911 11955 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "mcpar")= num [1:3] 10001 19991 10</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;  $ mcmc.alpha         : 'mcmc' num [1:1000, 1:210] -0.0559 -0.1139 0.0947 -0.2999 -0.1052 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "mcpar")= num [1:3] 10001 19991 10</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;  $ mcmc.V_alpha       : 'mcmc' num [1:1000, 1] 0.454 0.393 0.474 0.436 0.42 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "mcpar")= num [1:3] 10001 19991 10</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;  $ mcmc.sp            :List of 70</span></span>
<span><span class="co">#&gt;  $ mcmc.latent        :List of 2</span></span>
<span><span class="co">#&gt;  $ Z_latent           : num [1:210, 1:70] -1.758 -2.42 -1.414 -1.491 0.657 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;  $ probit_theta_latent: num [1:210, 1:70] -1.628 -2.394 -1.203 -1.271 -0.523 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;  $ theta_latent       : num [1:210, 1:70] 0.0666 0.0128 0.1321 0.1247 0.3084 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;  $ model_spec         :List of 24</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr "jSDM"</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="3">
<h2 id="evaluation-of-mcmc-convergence">
<span class="header-section-number">3</span> Evaluation of MCMC convergence<a class="anchor" aria-label="anchor" href="#evaluation-of-mcmc-convergence"></a>
</h2>
<div class="section level3" number="3.1">
<h3 id="the-gelmanrubin-convergence-diagnostic">
<span class="header-section-number">3.1</span> The Gelman‚ÄìRubin convergence diagnostic<a class="anchor" aria-label="anchor" href="#the-gelmanrubin-convergence-diagnostic"></a>
</h3>
<div class="section level4" number="3.1.1">
<h4 id="definition">
<span class="header-section-number">3.1.1</span> Definition<a class="anchor" aria-label="anchor" href="#definition"></a>
</h4>
<p>The Gelman‚ÄìRubin diagnostic evaluates MCMC convergence by analyzing the difference between multiple Markov chains. The convergence is assessed by comparing the estimated between-chains and within-chain variances for each model parameter. Large differences between these variances indicate non convergence. See <span class="citation">Gelman &amp; Rubin (<a href="#ref-Gelman1992">1992</a>)</span> and <span class="citation">Brooks &amp; Gelman (<a href="#ref-Brooks1998">1998</a>)</span> for the detailed description of the method.</p>
<p>Suppose we have <span class="math inline">\(M\)</span> chains, each of length <span class="math inline">\(N\)</span>, although the chains may be of different lengths. The same-length assumption simplifies the formulas and is used for convenience. For a model parameter <span class="math inline">\(\theta\)</span>, let <span class="math inline">\(\left(\theta_{ùëöt}\right)_{t=1}^N\)</span> be the <span class="math inline">\(ùëö\)</span>th simulated chain, <span class="math inline">\(ùëö=1,\dots,ùëÄ\)</span>.<br>
Let <span class="math inline">\(\hat{\theta}_ùëö=\frac{1}{N}\sum\limits_{t=1}^N \hat{\theta}_{mt}\)</span> and <span class="math inline">\(\hat{\sigma}^2_ùëö=\frac{1}{N-1}\sum\limits_{t=1}^N (\hat{\theta}_{mt}-\hat{\theta}_ùëö)^2\)</span> be the sample posterior mean and variance of the <span class="math inline">\(ùëö\)</span>th chain, and let the overall sample posterior mean be <span class="math inline">\(\hat{\theta}=\frac{1}{ùëÄ}\sum\limits_{m=1}^ùëÄ \hat{\theta}_m\)</span>.</p>
<p>The between-chains and within-chain variances are given by
<span class="math display">\[B=\frac{N}{M-1}\sum\limits_{m=1}^ùëÄ (\hat{\theta}_m - \hat{\theta})^2\]</span>
<span class="math display">\[W=\frac{1}{M}\sum\limits_{m=1}^ùëÄ\hat{\sigma}^2_m\]</span></p>
<p>Under certain stationarity conditions, the pooled variance :</p>
<p><span class="math display">\[\hat{V}=\frac{N-1}{N}W + \frac{M+1}{MN}B\]</span></p>
<p>is an unbiased estimator of the marginal posterior variance of <span class="math inline">\(\theta\)</span> (<span class="citation">Gelman &amp; Rubin (<a href="#ref-Gelman1992">1992</a>)</span>). The potential scale reduction factor (PSRF) is defined to be the ratio of <span class="math inline">\(\hat{ùëâ}\)</span> and <span class="math inline">\(ùëä\)</span>. If the <span class="math inline">\(ùëÄ\)</span> chains have converged to the target posterior distribution, then PSRF should be close to 1. The article <span class="citation">Brooks &amp; Gelman (<a href="#ref-Brooks1998">1998</a>)</span> corrected the original PSRF by accounting for sampling variability as follows:
<span class="math display">\[\hat{R}= \sqrt{\frac{\hat{d}+3}{\hat{d}+1}\frac{\hat{V}}{W}}\]</span></p>
<p>where <span class="math inline">\(\hat{d}\)</span> is the degrees of freedom estimate of a <span class="math inline">\(ùë°\)</span> distribution.</p>
<p>PSRF estimates the potential decrease in the between-chains variability <span class="math inline">\(ùêµ\)</span> with respect to the within-chain variability <span class="math inline">\(ùëä\)</span>. If <span class="math inline">\(\hat{R}\)</span> is large, then longer simulation sequences are expected to either decrease <span class="math inline">\(ùêµ\)</span> or increase <span class="math inline">\(ùëä\)</span> because the simulations have not yet explored the full posterior distribution. As the article <span class="citation">Brooks &amp; Gelman (<a href="#ref-Brooks1998">1998</a>)</span> have suggested, if <span class="math inline">\(\hat{R} &lt; 1.2\)</span> for all model parameters, one can be fairly confident that convergence has been reached. Otherwise, longer chains or other means for improving the convergence may be needed. Even more reassuring is to apply the more stringent condition <span class="math inline">\(\hat{R} &lt; 1.1\)</span>.</p>
</div>
<div class="section level4" number="3.1.2">
<h4 id="compute-hatr">
<span class="header-section-number">3.1.2</span> Compute <span class="math inline">\(\hat{R}\)</span><a class="anchor" aria-label="anchor" href="#compute-hatr"></a>
</h4>
<p>We evaluate the convergence of the MCMC output in which four parallel chains are run (with starting values that are over dispersed relative to the posterior distribution).
Convergence is diagnosed when the four chains have ‚Äòforgotten‚Äô their initial values, and the output from all chains is indistinguishable.
If the convergence diagnostic gives values of potential scale reduction factor (PSRF) or <span class="math inline">\(\hat{R}\)</span> substantially above 1, its indicates lack of convergence.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_probit</span> <span class="op">&lt;-</span> <span class="va">mod_probit_1</span></span>
<span><span class="va">burnin</span> <span class="op">&lt;-</span> <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">burnin</span></span>
<span><span class="va">ngibbs</span> <span class="op">&lt;-</span> <span class="va">burnin</span> <span class="op">+</span> <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">mcmc</span></span>
<span><span class="va">thin</span> <span class="op">&lt;-</span>  <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">thin</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span></span>
<span><span class="va">arr2mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>              start<span class="op">=</span><span class="va">burnin</span><span class="op">+</span><span class="fl">1</span> , end<span class="op">=</span><span class="va">ngibbs</span>, thin<span class="op">=</span><span class="va">thin</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># MCMC lists</span></span>
<span><span class="va">mcmc_list_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_list_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.V_alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_list_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.latent"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_list_deviance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.Deviance"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_list_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.sp"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_list_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"lambda"</span>, </span>
<span>                                                           <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                                           value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_list_deviance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span>,<span class="st">"[["</span>,<span class="st">"mcmc.Deviance"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nsamp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># psrf gelman indice </span></span>
<span><span class="va">psrf_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span>,</span>
<span>                               multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">psrf_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span><span class="va">psrf_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                              multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">psrf_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span>,</span>
<span>                                multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">psrf_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span>,</span>
<span>                            multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span> <span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="va">psrf_lambda</span>, <span class="va">psrf_lv</span>, <span class="va">psrf_alpha</span>, <span class="va">psrf_V_alpha</span>, <span class="va">psrf_beta</span>,</span>
<span>     file<span class="op">=</span><span class="st">"jSDM_in_parallel_cache/psrf.rda"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Rhat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">psrf_alpha</span>, <span class="va">psrf_V_alpha</span>, <span class="va">psrf_beta</span>, <span class="va">psrf_lambda</span>, <span class="va">psrf_lv</span><span class="op">)</span>,</span>
<span>                   Variable<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"Valpha"</span>, <span class="st">"beta"</span>, <span class="st">"lambda"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Barplot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Rhat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Variable</span>, y<span class="op">=</span><span class="va">Rhat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Averages of Rhat obtained for each type of parameter"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">13</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"skyblue"</span>, stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Rhat</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>, vjust<span class="op">=</span><span class="fl">0</span>, hjust<span class="op">=</span><span class="op">-</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">'red'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Rhat</span><span class="op">$</span><span class="va">Rhat</span><span class="op">)</span><span class="op">+</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="jSDM_in_parallel_files/figure-html/MCMC-convergence-randsite-lv-1.png" width="700" style="display: block; margin: auto;"></p>
<p>We can see that the <span class="math inline">\(\hat{R}\)</span> are very close to 1 for the species effects <span class="math inline">\(\beta\)</span>, the site effects <span class="math inline">\(\alpha\)</span> and their variance <span class="math inline">\(V_{alpha}\)</span>. The <span class="math inline">\(\hat{R}\)</span> obtained for the latent variables <span class="math inline">\(W\)</span> and the factor loadings <span class="math inline">\(\lambda\)</span> are also very close to 1. We can therefore be fairly confident that convergence has been achieved for all the parameters.</p>
</div>
</div>
</div>
<div class="section level2" number="4">
<h2 id="representation-of-results">
<span class="header-section-number">4</span> Representation of results<a class="anchor" aria-label="anchor" href="#representation-of-results"></a>
</h2>
<p>We visually evaluate the convergence of MCMCs by representing the trace and density <em>a posteriori</em> of some estimated parameters.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot trace and posterior distributions </span></span>
<span><span class="co"># for two first species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>, cex.main<span class="op">=</span><span class="fl">0.9</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="va">n_q</span><span class="op">)</span><span class="op">*</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># for two first sites </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="va">n_sites</span><span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span></span>
<span><span class="fu">coda</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/densplot.html" class="external-link">densplot</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">V_alpha.target</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend<span class="op">=</span><span class="st">"V_alpha.target"</span>,</span>
<span>       lwd<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">'red'</span>, cex<span class="op">=</span><span class="fl">0.7</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span>,</span>
<span>     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Deviance </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_deviance</span>,</span>
<span>     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="jSDM_in_parallel_files/figure-html/est-probit-1.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-2.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-3.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-4.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-5.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-6.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-7.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-8.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/est-probit-9.png" width="800" style="display: block; margin: auto;"></p>
<p>Overall, the traces and the densities of the parameters indicate the convergence of the algorithm. Indeed, we observe on the traces that the values oscillate around averages without showing an upward or downward trend and we see that the densities are quite smooth and for the most part of Gaussian form.</p>
</div>
<div class="section level2" number="5">
<h2 id="accuracy-of-predictions">
<span class="header-section-number">5</span> Accuracy of predictions<a class="anchor" aria-label="anchor" href="#accuracy-of-predictions"></a>
</h2>
<p>We evaluate the accuracy of the estimated parameters by plotting them against the parameters used to simulate the data-set.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Predictive posterior mean for each observation</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Species effects beta and factor loadings lambda</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.sp</span>,<span class="va">colMeans</span><span class="op">)</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_species</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_p</span><span class="op">]</span>,</span>
<span>         main<span class="op">=</span><span class="st">"species effect beta"</span>,</span>
<span>         xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta_target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">n_p</span><span class="op">]</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.sp</span>,<span class="va">colMeans</span><span class="op">)</span><span class="op">)</span>, nrow<span class="op">=</span><span class="va">n_species</span>, byrow<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">lambda_target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="va">n_q</span><span class="op">)</span><span class="op">]</span>,</span>
<span>         main<span class="op">=</span><span class="st">"factor loadings lambda"</span>,</span>
<span>         xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">lambda_target</span><span class="op">)</span>, <span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="va">n_q</span><span class="op">)</span><span class="op">]</span>,</span>
<span>           col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># W latent variables</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mean_W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n_sites</span>,<span class="va">n_q</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_q</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">mean_W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.latent</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"lv_"</span>,<span class="va">l</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="st">"Mean"</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>, <span class="va">mean_W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>,</span>
<span>           main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Latent variable W_"</span>, <span class="va">l</span><span class="op">)</span>,</span>
<span>           xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">else</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>, <span class="va">mean_W</span><span class="op">[</span>,<span class="va">l</span><span class="op">]</span>,col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># W.lambda</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">W</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">lambda_target</span>,<span class="va">mean_W</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="va">n_q</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>         main <span class="op">=</span> <span class="st">"W.lambda"</span>,</span>
<span>         xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">W</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">lambda_target</span>,<span class="va">mean_W</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">param</span><span class="op">[</span>,<span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">n_p</span><span class="op">+</span><span class="va">n_q</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>           ,col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#= Random site effect alpha </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">alpha_target</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.alpha</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span><span class="st">"obs"</span>, ylab <span class="op">=</span><span class="st">"fitted"</span>, main<span class="op">=</span><span class="st">"site effect alpha"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">alpha_target</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.alpha</span><span class="op">)</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#= Predictions </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">probit_theta</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_latent</span>,</span>
<span>     main<span class="op">=</span><span class="st">"probit(theta)"</span>,xlab<span class="op">=</span><span class="st">"obs"</span>,ylab<span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co">## probit(tetha)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">probit_theta</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_latent</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span>
<span><span class="co">## Z</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Z_latent</span>,</span>
<span>     main<span class="op">=</span><span class="st">"Z_latent"</span>, xlab<span class="op">=</span><span class="st">"obs"</span>, ylab<span class="op">=</span><span class="st">"fitted"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">mod_probit</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">Z_latent</span>, col<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>a<span class="op">=</span><span class="fl">0</span>,b<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="jSDM_in_parallel_files/figure-html/obs-fitted-1.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/obs-fitted-2.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/obs-fitted-3.png" width="800" style="display: block; margin: auto;"><img src="jSDM_in_parallel_files/figure-html/obs-fitted-4.png" width="800" style="display: block; margin: auto;"></p>
<p>On the above figures, the estimated parameters are close to the expected values if the points are near the red line representing the identity function (<span class="math inline">\(y=x\)</span>).</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Brooks1998" class="csl-entry">
Brooks, S. &amp; Gelman, A. (1998) <a href="https://doi.org/10.1080/10618600.1998.10474787" class="external-link">General <span>Methods</span> for <span>Monitoring</span> <span>Convergence</span> of <span>Iterative</span> <span>Simulations</span></a>. <em>J. Comput. Graphi. Stat.</em>, <strong>7</strong>, 434‚Äì455.
</div>
<div id="ref-Gelman1992" class="csl-entry">
Gelman, A. &amp; Rubin, D.B. (1992) <a href="https://doi.org/10.1214/ss/1177011136" class="external-link">Inference from <span>Iterative</span> <span>Simulation</span> <span>Using</span> <span>Multiple</span> <span>Sequences</span></a>. <em>Statistical Science</em>, <strong>7</strong>, 457‚Äì472.
</div>
<div id="ref-Warton2015" class="csl-entry">
Warton, D.I., Blanchet, F.G., O‚ÄôHara, R.B., Ovaskainen, O., Taskinen, S., Walker, S.C. &amp; Hui, F.K.C. (2015) <a href="https://doi.org/10.1016/j.tree.2015.09.007" class="external-link">So many variables: Joint modeling in community ecology</a>. <em>Trends in Ecology &amp; Evolution</em>, <strong>30</strong>, 766‚Äì779.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://ecology.ghislainv.fr" class="external-link">Ghislain Vieilledent</a>, <a href="https://jeanneclement.github.io/" class="external-link">Jeanne Cl√©ment</a>, <a href="https://www.cirad.fr" class="external-link"><img src="https://ecology.ghislainv.fr/jSDM/logos/logo-cirad.png"></a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
