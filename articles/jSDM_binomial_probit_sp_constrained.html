<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bernoulli probit regression with selected constrained species • jSDM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Bernoulli probit regression with selected constrained species">
<meta property="og:description" content="jSDM">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">jSDM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/jSDM.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Change log</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ghislainv/jSDM" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Bernoulli probit regression with selected constrained species</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ghislainv/jSDM/blob/HEAD/vignettes/jSDM_binomial_probit_sp_constrained.Rmd" class="external-link"><code>vignettes/jSDM_binomial_probit_sp_constrained.Rmd</code></a></small>
      <div class="hidden name"><code>jSDM_binomial_probit_sp_constrained.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="load-librairies">
<span class="header-section-number">1</span> Load librairies<a class="anchor" aria-label="anchor" href="#load-librairies"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ===================================================</span>
<span class="co"># Load libraries</span>
<span class="co"># ===================================================</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: foreach</span>
<span class="co">#&gt; Loading required package: iterators</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ecology.ghislainv.fr/jSDM/" class="external-link">jSDM</a></span><span class="op">)</span>
<span class="co">#&gt; ##</span>
<span class="co">#&gt; ## jSDM R package </span>
<span class="co">#&gt; ## For joint species distribution models </span>
<span class="co">#&gt; ## https://ecology.ghislainv.fr/jSDM </span>
<span class="co">#&gt; ##</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/" class="external-link">kableExtra</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-definition">
<span class="header-section-number">2</span> Model definition<a class="anchor" aria-label="anchor" href="#model-definition"></a>
</h2>
<p>Referring to the models used in the articles <span class="citation">Warton <em>et al.</em> (<a href="#ref-Warton2015" role="doc-biblioref">2015</a>)</span> and <span class="citation">Albert &amp; Siddhartha (<a href="#ref-Albert1993" role="doc-biblioref">1993</a>)</span>, we define the following model :</p>
<p><span class="math display">\[ \mathrm{probit}(\theta_{ij}) =\alpha_i + \beta_{0j}+X_i.\beta_j+ W_i.\lambda_j \]</span></p>
<ul>
<li><p>Link function probit: <span class="math inline">\(\mathrm{probit}: q \rightarrow \Phi^{-1}(q)\)</span> where <span class="math inline">\(\Phi\)</span> correspond to the distribution function of the reduced centered normal distribution.</p></li>
<li><p>Response variable: <span class="math inline">\(Y=(y_{ij})^{i=1,\ldots,nsite}_{j=1,\ldots,nsp}\)</span> with:</p></li>
</ul>
<p><span class="math display">\[y_{ij}=\begin{cases}
0 &amp; \text{ if species $j$ is absent on the site $i$}\\
1 &amp;  \text{ if species  $j$ is present on the site $i$}.
\end{cases}\]</span></p>
<ul>
<li>Latent variable <span class="math inline">\(z_{ij} = \alpha_i + \beta_{0j} + X_i.\beta_j + W_i.\lambda_j + \epsilon_{i,j}\)</span>, with <span class="math inline">\(\forall (i,j) \ \epsilon_{ij} \sim \mathcal{N}(0,1)\)</span> and such that:</li>
</ul>
<p><span class="math display">\[y_{ij}=\begin{cases}
1 &amp; \text{if} \ z_{ij} &gt; 0 \\
0 &amp;  \text{otherwise.}
\end{cases}\]</span></p>
<p>It can be easily shown that: <span class="math inline">\(y_{ij} \sim \mathcal{B}ernoulli(\theta_{ij})\)</span>.</p>
<ul>
<li><p>Latent variables: <span class="math inline">\(W_i=(W_i^1,\ldots,W_i^q)\)</span> where <span class="math inline">\(q\)</span> is the number of latent variables considered, which has to be fixed by the user (by default <span class="math inline">\(q=2\)</span>).
We assume that <span class="math inline">\(W_i \sim \mathcal{N}(0,I_q)\)</span> and we define the associated coefficients: <span class="math inline">\(\lambda_j=(\lambda_j^1,\ldots, \lambda_j^q)'\)</span>. We use a prior distribution <span class="math inline">\(\mathcal{N}(0,10)\)</span> for all lambdas not concerned by constraints to <span class="math inline">\(0\)</span> on upper diagonal and to strictly positive values on diagonal.</p></li>
<li><p>Explanatory variables: bioclimatic data about each site. <span class="math inline">\(X=(X_i)_{i=1,\ldots,nsite}\)</span> with <span class="math inline">\(X_i=(x_i^1,\ldots,x_i^p)\in \mathbb{R}^p\)</span> where <span class="math inline">\(p\)</span> is the number of bioclimatic variables considered.
The corresponding regression coefficients for each species <span class="math inline">\(j\)</span> are noted : <span class="math inline">\(\beta_j=(\beta_j^1,\ldots,\beta_j^p)'\)</span>.</p></li>
<li><p><span class="math inline">\(\beta_{0j}\)</span> correspond to the intercept for species <span class="math inline">\(j\)</span> which is assumed to be a fixed effect. We use a prior distribution <span class="math inline">\(\mathcal{N}(0,10)\)</span> for all betas.</p></li>
<li><p><span class="math inline">\(\alpha_i\)</span> represents the random effect of site <span class="math inline">\(i\)</span> such as <span class="math inline">\(\alpha_i \sim \mathcal{N}(0,V_{\alpha})\)</span> and we assume that <span class="math inline">\(V_{\alpha} \sim \mathcal {IG}(\text{shape}=0.5, \text{rate}=0.005)\)</span> as prior distribution by default.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="occurrence-data-set">
<span class="header-section-number">3</span> Occurrence data-set<a class="anchor" aria-label="anchor" href="#occurrence-data-set"></a>
</h2>

<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:frog-picture"></span>
<img src="figures/Fungi_.jpg" alt="Fungi (Wilkinson et al. 2019)." width="400" height="300"><p class="caption">
Figure 3.1: <strong>Fungi</strong> <span class="citation">(Wilkinson <em>et al.</em> <a href="#ref-Wilkinson2019" role="doc-biblioref">2019</a>)</span>.
</p>
</div>
<p>This data-set is available in the <a href="https://ecology.ghislainv.fr/jSDM/reference/jSDM-package.html" class="external-link"><code>jSDM-package</code></a> R package. It can be loaded with the <code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code> command. The <a href="https://ecology.ghislainv.fr/jSDM/reference/fungi.html" class="external-link"><code>fungi</code></a> dataset is in “wide” format: each line is a site and the occurrence data are in columns. A site is characterized by its x-y geographical coordinates twelve covariates.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ecology.ghislainv.fr/jSDM/" class="external-link">jSDM</a></span><span class="op">)</span>
<span class="co"># frogs data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">fungi</span>, package<span class="op">=</span><span class="st">"jSDM"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fungi</span><span class="op">)</span>
<span class="co">#&gt;   antser antsin astfer fompin hetpar junlut phefer phenig phevit poscae triabi</span>
<span class="co">#&gt; 1      0      0      0      0      0      0      1      0      0      0      0</span>
<span class="co">#&gt; 2      0      0      0      0      0      0      0      0      0      0      0</span>
<span class="co">#&gt; 3      0      0      0      0      0      0      0      0      1      0      0</span>
<span class="co">#&gt; 4      0      0      0      0      0      0      0      0      1      0      0</span>
<span class="co">#&gt; 5      0      0      0      0      0      0      0      0      0      0      0</span>
<span class="co">#&gt; 6      0      0      0      0      0      0      0      0      0      0      0</span>
<span class="co">#&gt;         diam dc1 dc2 dc3 dc4 dc5 quality3 quality4 ground3 ground4        epi</span>
<span class="co">#&gt; 1  1.3699426   1   0   0   0   0        0        1       0       1 -0.6626584</span>
<span class="co">#&gt; 2 -0.2083835   0   0   0   0   0        1        0       0       0 -0.6626584</span>
<span class="co">#&gt; 3  0.2435434   0   0   0   0   0        0        1       0       1 -0.3568567</span>
<span class="co">#&gt; 4  0.8040889   1   0   0   0   0        0        1       0       0 -0.6626584</span>
<span class="co">#&gt; 5 -0.5927520   0   0   0   0   0        0        1       0       0 -0.6626584</span>
<span class="co">#&gt; 6 -0.8227620   0   0   1   0   0        0        0       0       1 -0.3568567</span>
<span class="co">#&gt;         bark</span>
<span class="co">#&gt; 1  0.5297272</span>
<span class="co">#&gt; 2  1.2511949</span>
<span class="co">#&gt; 3 -1.0334527</span>
<span class="co">#&gt; 4 -0.9132081</span>
<span class="co">#&gt; 5  1.2511949</span>
<span class="co">#&gt; 6  1.2511949</span></code></pre></div>
<p>We rearrange the data in two data-sets: a first one for the presence-absence observations for each species (columns) at each site (rows), and a second one for the site characteristics.</p>
<p>We also normalize the continuous explanatory variables to facilitate MCMC convergence.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Fungi data-set</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">fungi</span>, package<span class="op">=</span><span class="st">"jSDM"</span><span class="op">)</span>
<span class="va">PA_Fungi</span> <span class="op">&lt;-</span> <span class="va">fungi</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"antser"</span>,<span class="st">"antsin"</span>,<span class="st">"astfer"</span>,<span class="st">"fompin"</span>,<span class="st">"hetpar"</span>,<span class="st">"junlut"</span>,
                     <span class="st">"phefer"</span>,<span class="st">"phenig"</span>,<span class="st">"phevit"</span>,<span class="st">"poscae"</span>,<span class="st">"triabi"</span><span class="op">)</span><span class="op">]</span>

<span class="co"># Normalized continuous variables</span>
<span class="va">Env_Fungi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">fungi</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"diam"</span>,<span class="st">"epi"</span>,<span class="st">"bark"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
                   <span class="va">fungi</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dc1"</span>,<span class="st">"dc2"</span>,<span class="st">"dc3"</span>,<span class="st">"dc4"</span>,<span class="st">"dc5"</span>,
                            <span class="st">"quality3"</span>,<span class="st">"quality4"</span>,<span class="st">"ground3"</span>,<span class="st">"ground4"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">Env_Fungi</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"diam"</span>,<span class="st">"epi"</span>,<span class="st">"bark"</span>,<span class="st">"dc1"</span>,<span class="st">"dc2"</span>,<span class="st">"dc3"</span>,<span class="st">"dc4"</span>,<span class="st">"dc5"</span>,
                         <span class="st">"quality3"</span>,<span class="st">"quality4"</span>,<span class="st">"ground3"</span>,<span class="st">"ground4"</span><span class="op">)</span>
<span class="co"># Remove sites where none species was recorded</span>
<span class="va">Env_Fungi</span> <span class="op">&lt;-</span> <span class="va">Env_Fungi</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">PA_Fungi</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span>,<span class="op">]</span>
<span class="va">PA_Fungi</span><span class="op">&lt;-</span> <span class="va">PA_Fungi</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">PA_Fungi</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span>,<span class="op">]</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fitting-jsdm-with-the-species-on-first-columns-constrained">
<span class="header-section-number">4</span> Fitting JSDM with the species on first columns constrained<a class="anchor" aria-label="anchor" href="#fitting-jsdm-with-the-species-on-first-columns-constrained"></a>
</h2>
<div class="section level3">
<h3 id="parameter-inference">
<span class="header-section-number">4.1</span> Parameter inference<a class="anchor" aria-label="anchor" href="#parameter-inference"></a>
</h3>
<p>As a first step we use the <code><a href="../reference/jSDM_binomial_probit.html">jSDM_binomial_probit()</a></code> function to fit the JSDM in parallel to obtain four MCMC chains of parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Make a cluster for parallel MCMCs</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="va">ncores</span> <span class="op">&lt;-</span> <span class="va">nchains</span> <span class="co">## One core for each MCMC chains</span>
<span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span>

<span class="co"># Seeds</span>
<span class="va">seed_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">123</span>, <span class="fl">1234</span>, <span class="fl">12345</span><span class="op">)</span>

<span class="co"># Model</span>
<span class="va">mod_Fungi</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span> <span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span>
    <span class="co"># Inferring model parameters</span>
    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu">jSDM</span><span class="fu">::</span><span class="fu"><a href="../reference/jSDM_binomial_probit.html">jSDM_binomial_probit</a></span><span class="op">(</span><span class="co"># Chains</span>
                                      burnin<span class="op">=</span><span class="fl">5000</span>,
                                      mcmc<span class="op">=</span><span class="fl">10000</span>,
                                      thin<span class="op">=</span><span class="fl">10</span>,
                                      <span class="co"># Response variable </span>
                                      presence_data <span class="op">=</span> <span class="va">PA_Fungi</span>, 
                                      <span class="co"># Explanatory variables </span>
                                      site_formula <span class="op">=</span> <span class="op">~</span><span class="va">.</span>,   
                                      site_data <span class="op">=</span> <span class="va">Env_Fungi</span>,
                                      <span class="co"># Model specification </span>
                                      n_latent<span class="op">=</span><span class="fl">2</span>, 
                                      site_effect<span class="op">=</span><span class="st">"random"</span>,
                                      <span class="co"># Starting values</span>
                                      alpha_start<span class="op">=</span><span class="fl">0</span>,
                                      beta_start<span class="op">=</span><span class="fl">0</span>,
                                      lambda_start<span class="op">=</span><span class="fl">0</span>, 
                                      W_start<span class="op">=</span><span class="fl">0</span>,
                                      V_alpha<span class="op">=</span><span class="fl">1</span>, 
                                      <span class="co"># Priors</span>
                                      shape<span class="op">=</span><span class="fl">0.1</span>, 
                                      rate<span class="op">=</span><span class="fl">0.1</span>,
                                      mu_beta<span class="op">=</span><span class="fl">0</span>, 
                                      V_beta<span class="op">=</span><span class="fl">1</span>,
                                      mu_lambda<span class="op">=</span><span class="fl">0</span>,
                                      V_lambda<span class="op">=</span><span class="fl">1</span>,
                                      <span class="co"># Other</span>
                                      seed <span class="op">=</span> <span class="va">seed_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                                      verbose <span class="op">=</span> <span class="fl">0</span>
    <span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>
  <span class="op">}</span>
<span class="co"># Stop cluster</span>
<span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-gelmanrubin-convergence-diagnostic">
<span class="header-section-number">4.2</span> The Gelman–Rubin convergence diagnostic<a class="anchor" aria-label="anchor" href="#the-gelmanrubin-convergence-diagnostic"></a>
</h3>
<div class="section level4">
<h4 id="definition">
<span class="header-section-number">4.2.1</span> Definition<a class="anchor" aria-label="anchor" href="#definition"></a>
</h4>
<p>The Gelman–Rubin diagnostic evaluates MCMC convergence by analyzing the difference between multiple Markov chains. The convergence is assessed by comparing the estimated between-chains and within-chain variances for each model parameter. Large differences between these variances indicate nonconvergence. See <span class="citation">Gelman &amp; Rubin (<a href="#ref-Gelman1992" role="doc-biblioref">1992</a>)</span> and <span class="citation">Brooks &amp; Gelman (<a href="#ref-Brooks1998" role="doc-biblioref">1998</a>)</span> for the detailed description of the method.</p>
<p>Suppose we have <span class="math inline">\(M\)</span> chains, each of length <span class="math inline">\(N\)</span>, although the chains may be of different lengths. The same-length assumption simplifies the formulas and is used for convenience. For a model parameter <span class="math inline">\(\theta\)</span>, let <span class="math inline">\(\left(\theta_{𝑚t}\right)_{t=1}^N\)</span> be the <span class="math inline">\(𝑚\)</span>th simulated chain, <span class="math inline">\(𝑚=1,\dots,𝑀\)</span>. Let <span class="math inline">\(\hat{\theta}_𝑚=\frac{1}{N}\sum\limits_{t=1}^N \hat{\theta}_{mt}\)</span> and <span class="math inline">\(\hat{\sigma}^2_𝑚=\frac{1}{N-1}\sum\limits_{t=1}^N (\hat{\theta}_{mt}-\hat{\theta}_𝑚)^2\)</span> be the sample posterior mean and variance of the <span class="math inline">\(𝑚\)</span>th chain, and let the overall sample posterior mean be <span class="math inline">\(\hat{\theta}=\frac{1}{𝑀}\sum\limits_{m=1}^𝑀 \hat{\theta}_m\)</span>.</p>
<p>The between-chains and within-chain variances are given by
<span class="math display">\[B=\frac{N}{M-1}\sum\limits_{m=1}^𝑀 (\hat{\theta}_m - \hat{\theta})^2\]</span>
<span class="math display">\[W=\frac{1}{M}\sum\limits_{m=1}^𝑀\hat{\sigma}^2_m\]</span></p>
<p>Under certain stationarity conditions, the pooled variance :</p>
<p><span class="math display">\[\hat{V}=\frac{N-1}{N}W + \frac{M+1}{MN}B\]</span></p>
<p>is an unbiased estimator of the marginal posterior variance of <span class="math inline">\(\theta\)</span> (<span class="citation">Gelman &amp; Rubin (<a href="#ref-Gelman1992" role="doc-biblioref">1992</a>)</span>). The potential scale reduction factor (PSRF) is defined to be the ratio of <span class="math inline">\(\hat{𝑉}\)</span> and <span class="math inline">\(𝑊\)</span>. If the <span class="math inline">\(𝑀\)</span> chains have converged to the target posterior distribution, then PSRF should be close to 1. The article <span class="citation">Brooks &amp; Gelman (<a href="#ref-Brooks1998" role="doc-biblioref">1998</a>)</span> corrected the original PSRF by accounting for sampling variability as follows:
<span class="math display">\[ \hat{R}= \sqrt{\frac{\hat{d}+3}{\hat{d}+1}\frac{\hat{V}}{W}}\]</span></p>
<p>where <span class="math inline">\(\hat{d}\)</span> is the degrees of freedom estimate of a <span class="math inline">\(𝑡\)</span> distribution.</p>
<p>PSRF estimates the potential decrease in the between-chains variability <span class="math inline">\(𝐵\)</span> with respect to the within-chain variability <span class="math inline">\(𝑊\)</span>. If <span class="math inline">\(\hat{R}\)</span> is large, then longer simulation sequences are expected to either decrease <span class="math inline">\(𝐵\)</span> or increase <span class="math inline">\(𝑊\)</span> because the simulations have not yet explored the full posterior distribution. As the article <span class="citation">Brooks &amp; Gelman (<a href="#ref-Brooks1998" role="doc-biblioref">1998</a>)</span> have suggested, if <span class="math inline">\(\hat{R} &lt; 1.2\)</span> for all model parameters, one can be fairly confident that convergence has been reached. Otherwise, longer chains or other means for improving the convergence may be needed. Even more reassuring is to apply the more stringent condition <span class="math inline">\(\hat{R} &lt; 1.1\)</span>.</p>
</div>
<div class="section level4">
<h4 id="compute-hatr">
<span class="header-section-number">4.2.2</span> Compute <span class="math inline">\(\hat{R}\)</span><a class="anchor" aria-label="anchor" href="#compute-hatr"></a>
</h4>
<p>We evaluate the convergence of the MCMC output in which four parallel chains are run (with starting values that are over dispersed relative to the posterior distribution).
Convergence is diagnosed when the four chains have ‘forgotten’ their initial values, and the output from all chains is indistinguishable.
If the convergence diagnostic gives values of potential scale reduction factor (PSRF) or <span class="math inline">\(\hat{R}\)</span>
substantially above 1, its indicates lack of convergence.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Number of latent variables </span>
<span class="va">n_latent</span> <span class="op">&lt;-</span> <span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">n_latent</span>
<span class="co"># Results from list to mcmc.list format</span>
<span class="va">burnin</span> <span class="op">&lt;-</span> <span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">burnin</span>
<span class="va">ngibbs</span> <span class="op">&lt;-</span> <span class="va">burnin</span> <span class="op">+</span> <span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">mcmc</span>
<span class="va">thin</span> <span class="op">&lt;-</span>  <span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">thin</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span>
<span class="va">arr2mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
              start<span class="op">=</span><span class="va">burnin</span><span class="op">+</span><span class="fl">1</span> , end<span class="op">=</span><span class="va">ngibbs</span>, thin<span class="op">=</span><span class="va">thin</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">mcmc_list_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi</span>,<span class="st">"[["</span>,<span class="st">"mcmc.alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi</span>,<span class="st">"[["</span>,<span class="st">"mcmc.V_alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi</span>,<span class="st">"[["</span>,<span class="st">"mcmc.V_alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi</span>,<span class="st">"[["</span>,<span class="st">"mcmc.sp"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi</span>,<span class="st">"[["</span>,<span class="st">"mcmc.latent"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_beta</span> <span class="op">&lt;-</span> <span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"beta"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">mcmc_list_beta0</span> <span class="op">&lt;-</span> <span class="va">mcmc_list_beta</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">mcmc_list_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"lambda"</span>, 
                                     <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
                                     value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_Deviance</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi</span>,<span class="st">"[["</span>,<span class="st">"mcmc.Deviance"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Rhat</span>
<span class="va">psrf_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span>, multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">psrf_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>
<span class="va">psrf_beta0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_beta0</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">psrf_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, invert<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">psrf_lambda_diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_latent</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="co"># mean(psrf, na.rm=TRUE) because zeros on upper triangular Lambda matrix give NaN in psrf</span>
<span class="va">psrf_lambda_others</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">[</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n_latent</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>,
                                       multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,
                           na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="va">psrf_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">Rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Rhat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">psrf_alpha</span>, <span class="va">psrf_V_alpha</span>, <span class="va">psrf_beta0</span>, <span class="va">psrf_beta</span>,
                          <span class="va">psrf_lambda_diag</span>, <span class="va">psrf_lambda_others</span>, <span class="va">psrf_lv</span><span class="op">)</span>,
                   Variable<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"Valpha"</span>, <span class="st">"beta0"</span>, <span class="st">"beta"</span>,
                              <span class="st">"lambda \n on the diagonal"</span>, <span class="st">"others lambda"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Barplot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Rhat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Variable</span>, y<span class="op">=</span><span class="va">Rhat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Averages of Rhat obtained for each type of parameter"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">0.1</span>, r <span class="op">=</span> <span class="fl">0.2</span>, b <span class="op">=</span> <span class="fl">0.1</span>, l <span class="op">=</span> <span class="fl">0.1</span>,<span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"skyblue"</span>, stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Rhat</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>, vjust<span class="op">=</span><span class="fl">0</span>, hjust<span class="op">=</span><span class="op">-</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Rhat</span><span class="op">$</span><span class="va">Rhat</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">'red'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/jSDM-model-convergence-1.png" width="700" style="display: block; margin: auto;"></p>
<p>It can be seen that the <span class="math inline">\(\hat{R}\)</span>’s associated with the factor loadings <span class="math inline">\(\lambda\)</span> are well above 1, which indicates a lack of convergence for these parameters, even after <span class="math inline">\(15000\)</span> iterations including <span class="math inline">\(5000\)</span> burn-in.</p>
</div>
</div>
<div class="section level3">
<h3 id="analysis-of-the-results">
<span class="header-section-number">4.3</span> Analysis of the results<a class="anchor" aria-label="anchor" href="#analysis-of-the-results"></a>
</h3>
<div class="section level4">
<h4 id="representation-of-results">
<span class="header-section-number">4.3.1</span> Representation of results<a class="anchor" aria-label="anchor" href="#representation-of-results"></a>
</h4>
<p>We visually evaluate the convergence of MCMCs by representing the trace and density <em>a posteriori</em> of some estimated parameters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">beta_start</span><span class="op">)</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">)</span>
<span class="co">## beta_j of the first two species </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">np</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## lambda_j of the first two species </span>
<span class="va">n_latent</span> <span class="op">&lt;-</span> <span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">n_latent</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n_latent</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## Latent variables W_i for the first two sites</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">nsite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.alpha</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span> <span class="op">+</span> <span class="va">nsite</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## alpha_i of the first two sites</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>

<span class="co">## V_alpha</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## Deviance</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_Deviance</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## probit_theta</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_latent</span>,
     col<span class="op">=</span><span class="fl">1</span>,
     main <span class="op">=</span> <span class="st">"Predicted probit theta"</span>,
     xlab <span class="op">=</span><span class="st">"predicted probit theta"</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_latent</span>,
     add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># occurrence probabilities theta</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">theta_latent</span>,
     col<span class="op">=</span><span class="fl">1</span>, main <span class="op">=</span> <span class="st">"Predicted theta"</span>,
     xlab <span class="op">=</span><span class="st">"predicted theta"</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">theta_latent</span>,
     add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-1.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-2.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-3.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-4.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-5.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-6.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-7.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-8.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-9.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-10.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-11.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-12.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-13.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-14.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-15.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-16.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-17.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-18.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-19.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-20.png" width="700" style="display: block; margin: auto;"></p>
<p>Overall, the traces and the densities of the parameters indicate the convergence of the algorithm. Indeed, we observe on the traces that the values oscillate around averages without showing an upward or downward trend and we see that the densities are quite smooth and for the most part of Gaussian form, except for the factor loadings <span class="math inline">\(lambda\)</span>.<br>
In fact the values estimated for <span class="math inline">\(lambda\)</span> differ between the four chains and within each chain, the traces of these parameters oscillate very strongly showing upward or downward trends and we see that the densities are not of Gaussian form, as expected.</p>
<p>This lack of convergence can be explained by the arbitrary choice of the species constrained to have positive values of <span class="math inline">\(\lambda\)</span> as being the first ones in the presence-absence data set. Indeed, the constrained species are supposed to be the ones that structure themselves most clearly on each latent axis but by arbitrarily choosing them this is not necessarily the case.</p>
</div>
<div class="section level4">
<h4 id="matrice-of-residual-correlations">
<span class="header-section-number">4.3.2</span> Matrice of residual correlations<a class="anchor" aria-label="anchor" href="#matrice-of-residual-correlations"></a>
</h4>
<p>After fitting the jSDM with latent variables, the <strong>full species residual correlation matrix</strong> <span class="math inline">\(R=(R_{ij})^{i=1,\ldots, nspecies}_{j=1,\ldots, nspecies}\)</span> can be derived from the covariance in the latent variables such as :
<span class="math display">\[\Sigma_{ij} = \begin{cases}
\lambda_i .\lambda_j^T &amp; \text{ if } i \neq j \\
\lambda_i .\lambda_j^T + 1 &amp; \text{ if } i=j
\end{cases}\]</span>, then we compute correlations from covariances :
<span class="math display">\[R_{i,j} = \frac{\Sigma_{ij}}{\sqrt{\Sigma _{ii}\Sigma _{jj}}}\]</span>.</p>
<p>We use the <code><a href="../reference/get_residual_cor.html">get_residual_cor()</a></code> function to compute the residual correlation matrix <span class="math inline">\(R\)</span> for each chain and we and display the average of the <span class="math inline">\(R\)</span> matrices for all chains:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nsp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">beta_start</span><span class="op">)</span>
<span class="co"># Average residual correlation matrix on the four mcmc chains</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nsp</span>, <span class="va">nsp</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="fu"><a href="../reference/get_residual_cor.html">get_residual_cor</a></span><span class="op">(</span><span class="va">mod_Fungi</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">cor.mean</span><span class="op">/</span><span class="va">nchains</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">PA_Fungi</span><span class="op">)</span>
<span class="va">R.reorder</span> <span class="op">&lt;-</span> <span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrMatOrder.html" class="external-link">corrMatOrder</a></span><span class="op">(</span><span class="va">R</span>, order <span class="op">=</span> <span class="st">"FPC"</span>, hclust.method <span class="op">=</span> <span class="st">"average"</span><span class="op">)</span>
<span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="va">R.reorder</span>, <span class="va">R.reorder</span><span class="op">]</span>,  diag <span class="op">=</span> <span class="cn">F</span>, type <span class="op">=</span> <span class="st">"lower"</span>,
                   method <span class="op">=</span> <span class="st">"color"</span>,  mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span>,
                   tl.srt <span class="op">=</span> <span class="fl">45</span>, tl.cex <span class="op">=</span> <span class="fl">0.7</span>,
                   title <span class="op">=</span> <span class="st">"Residual Correlation Matrix from LVM"</span><span class="op">)</span></code></pre></div>
<p><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/correlation-matrix-probit-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="fitting-jsdm-with-the-chosen-constrained-species">
<span class="header-section-number">5</span> Fitting JSDM with the chosen constrained species<a class="anchor" aria-label="anchor" href="#fitting-jsdm-with-the-chosen-constrained-species"></a>
</h2>
<div class="section level3">
<h3 id="parameter-inference-1">
<span class="header-section-number">5.1</span> Parameter inference<a class="anchor" aria-label="anchor" href="#parameter-inference-1"></a>
</h3>
<p>As a second step we use the <code><a href="../reference/jSDM_binomial_probit_sp_constrained.html">jSDM_binomial_probit_sp_constrained()</a></code> function to fit the JSDM in parallel to obtain four MCMC chains of parameters.</p>
<p>This function returns the fitted JSDM considering as constrained species to positivity on the diagonal of the <span class="math inline">\(\Lambda\)</span> matrix those that maximize on each latent axis the <span class="math inline">\(\hat{R}\)</span>s computed from the factor loadings <span class="math inline">\(\lambda\)</span> of the first JSDM adjusted with the constrained species arbitrarily chosen as the first of the response matrix.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Model</span>
<span class="co"># Inferring model parameters</span>
<span class="va">mod_Fungi_ord</span> <span class="op">&lt;-</span> <span class="fu">jSDM</span><span class="fu">::</span><span class="fu"><a href="../reference/jSDM_binomial_probit_sp_constrained.html">jSDM_binomial_probit_sp_constrained</a></span><span class="op">(</span><span class="co"># Chains</span>
                                                           ncores<span class="op">=</span><span class="fl">4</span>,
                                                           nchains<span class="op">=</span><span class="fl">4</span>,
                                                           <span class="co"># Iteration</span>
                                                           burnin<span class="op">=</span><span class="fl">5000</span>,
                                                           mcmc<span class="op">=</span><span class="fl">10000</span>,
                                                           thin<span class="op">=</span><span class="fl">10</span>,
                                                           <span class="co"># Response variable </span>
                                                           presence_data <span class="op">=</span> <span class="va">PA_Fungi</span>, 
                                                           <span class="co"># Explanatory variables </span>
                                                           site_formula <span class="op">=</span> <span class="op">~</span><span class="va">.</span>,   
                                                           site_data <span class="op">=</span> <span class="va">Env_Fungi</span>,
                                                           <span class="co"># Model specification </span>
                                                           n_latent<span class="op">=</span><span class="fl">2</span>, 
                                                           site_effect<span class="op">=</span><span class="st">"random"</span>,
                                                           <span class="co"># Starting values</span>
                                                           alpha_start<span class="op">=</span><span class="fl">0</span>,
                                                           beta_start<span class="op">=</span><span class="fl">0</span>,
                                                           lambda_start<span class="op">=</span><span class="fl">0</span>, 
                                                           W_start<span class="op">=</span><span class="fl">0</span>,
                                                           V_alpha<span class="op">=</span><span class="fl">1</span>, 
                                                           <span class="co"># Priors</span>
                                                           shape<span class="op">=</span><span class="fl">0.1</span>, 
                                                           rate<span class="op">=</span><span class="fl">0.1</span>,
                                                           mu_beta<span class="op">=</span><span class="fl">0</span>, 
                                                           V_beta<span class="op">=</span><span class="fl">1</span>,
                                                           mu_lambda<span class="op">=</span><span class="fl">0</span>,
                                                           V_lambda<span class="op">=</span><span class="fl">1</span>,
                                                           <span class="co"># Other</span>
                                                           seed <span class="op">=</span> <span class="va">seed_mcmc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
                                                           verbose <span class="op">=</span> <span class="fl">0</span>
<span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-gelmanrubin-convergence-diagnostic-1">
<span class="header-section-number">5.2</span> The Gelman–Rubin convergence diagnostic<a class="anchor" aria-label="anchor" href="#the-gelmanrubin-convergence-diagnostic-1"></a>
</h3>
<div class="section level4">
<h4 id="compute-hatr-1">
<span class="header-section-number">5.2.1</span> Compute <span class="math inline">\(\hat{R}\)</span><a class="anchor" aria-label="anchor" href="#compute-hatr-1"></a>
</h4>
<p>We evaluate the convergence of the MCMC output in which four parallel chains are run (with starting values that are over dispersed relative to the posterior distribution).
Convergence is diagnosed when the four chains have ‘forgotten’ their initial values, and the output from all chains is indistinguishable.
If the convergence diagnostic gives values of potential scale reduction factor (PSRF) or <span class="math inline">\(\hat{R}\)</span>
substantially above 1, its indicates lack of convergence.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Results from list to mcmc.list format</span>
<span class="va">burnin</span> <span class="op">&lt;-</span> <span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">burnin</span>
<span class="va">ngibbs</span> <span class="op">&lt;-</span> <span class="va">burnin</span> <span class="op">+</span> <span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">mcmc</span>
<span class="va">thin</span> <span class="op">&lt;-</span>  <span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">thin</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">coda</span><span class="op">)</span>
<span class="va">arr2mcmc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.html" class="external-link">mcmc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,
              start<span class="op">=</span><span class="va">burnin</span><span class="op">+</span><span class="fl">1</span> , end<span class="op">=</span><span class="va">ngibbs</span>, thin<span class="op">=</span><span class="va">thin</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">mcmc_list_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span>,<span class="st">"[["</span>,<span class="st">"mcmc.alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span>,<span class="st">"[["</span>,<span class="st">"mcmc.V_alpha"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span>,<span class="st">"[["</span>,<span class="st">"mcmc.sp"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span>,<span class="st">"[["</span>,<span class="st">"mcmc.latent"</span><span class="op">)</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="va">mcmc_list_beta</span> <span class="op">&lt;-</span> <span class="va">mcmc_list_param</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"beta"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">mcmc_list_beta0</span> <span class="op">&lt;-</span> <span class="va">mcmc_list_beta</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>
<span class="va">mcmc_list_lambda</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/mcmc.list.html" class="external-link">mcmc.list</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"lambda"</span>, 
                                     <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_param</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
                                     value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span>, <span class="va">arr2mcmc</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Rhat</span>
<span class="va">psrf_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span>, multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">psrf_V_alpha</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>
<span class="va">psrf_beta0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_beta0</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">psrf_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"Intercept"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,invert<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">id_sp_constrained</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="kw">for</span><span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_latent</span><span class="op">)</span><span class="op">{</span>
<span class="va">id_sp_constrained</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id_sp_constrained</span>,
                       <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sp_constrained</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>, 
                            <span class="fu"><a href="https://rdrr.io/pkg/coda/man/varnames.html" class="external-link">varnames</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">psrf_lambda_diag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span>
  <span class="va">mcmc_list_lambda</span><span class="op">[</span>,<span class="va">id_sp_constrained</span><span class="op">]</span>,
  multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,
  na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># mean(psrf, na.rm=TRUE) because zeros on upper triangular Lambda matrix give NaN in psrf</span>
<span class="va">psrf_lambda_others</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">[</span>,<span class="op">-</span><span class="va">id_sp_constrained</span><span class="op">]</span>,
                                       multivariate<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">psrf_lv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/coda/man/gelman.diag.html" class="external-link">gelman.diag</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span><span class="op">)</span><span class="op">$</span><span class="va">psrf</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">Rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Rhat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">psrf_alpha</span>, <span class="va">psrf_V_alpha</span>, <span class="va">psrf_beta0</span>, <span class="va">psrf_beta</span>,
                          <span class="va">psrf_lambda_diag</span>, <span class="va">psrf_lambda_others</span>, <span class="va">psrf_lv</span><span class="op">)</span>,
                   Variable<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"Valpha"</span>, <span class="st">"beta0"</span>, <span class="st">"beta"</span>,
                              <span class="st">"lambda \n on the diagonal"</span>, <span class="st">"others lambda"</span>, <span class="st">"W"</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Barplot</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">Rhat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Variable</span>, y<span class="op">=</span><span class="va">Rhat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Averages of Rhat obtained for each type of parameter"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">0.1</span>, r <span class="op">=</span> <span class="fl">0.2</span>, b <span class="op">=</span> <span class="fl">0.1</span>, l <span class="op">=</span> <span class="fl">0.1</span>,<span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"skyblue"</span>, stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">Rhat</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>, vjust<span class="op">=</span><span class="fl">0</span>, hjust<span class="op">=</span><span class="op">-</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Rhat</span><span class="op">$</span><span class="va">Rhat</span><span class="op">)</span><span class="op">+</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">1</span>, color<span class="op">=</span><span class="st">'red'</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/Rhat-ord-1.png" width="700" style="display: block; margin: auto;"></p>
<p>It can be seen that the <span class="math inline">\(\hat{R}\)</span>’s associated with the factor loadings <span class="math inline">\(\lambda\)</span> are much closer to 1 than previously after the same number of iterations. Consequently the convergence of factor loadings has improved by selecting the constrained species.</p>
</div>
</div>
<div class="section level3">
<h3 id="analysis-of-the-results-1">
<span class="header-section-number">5.3</span> Analysis of the results<a class="anchor" aria-label="anchor" href="#analysis-of-the-results-1"></a>
</h3>
<div class="section level4">
<h4 id="representation-of-results-1">
<span class="header-section-number">5.3.1</span> Representation of results<a class="anchor" aria-label="anchor" href="#representation-of-results-1"></a>
</h4>
<p>We visually evaluate the convergence of MCMCs by representing the trace and density <em>a posteriori</em> of some estimated parameters.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">np</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">beta_start</span><span class="op">)</span>
<span class="va">n_latent</span> <span class="op">&lt;-</span> <span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">n_latent</span>
<span class="va">nchains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">)</span>
<span class="co">## beta_j of the first two species and the species constrained </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">np</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_latent</span><span class="op">)</span><span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sp_constrained</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>,
                           <span class="fu"><a href="https://rdrr.io/pkg/coda/man/varnames.html" class="external-link">varnames</a></span><span class="op">(</span><span class="va">mcmc_list_beta</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">## lambda_j of the first two species and the species constrained </span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">n_latent</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_latent</span><span class="op">)</span><span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sp_constrained</span><span class="op">[</span><span class="va">l</span><span class="op">]</span>,
                             <span class="fu"><a href="https://rdrr.io/pkg/coda/man/varnames.html" class="external-link">varnames</a></span><span class="op">(</span><span class="va">mcmc_list_lambda</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">## Latent variables W_i for the first two sites</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">nsite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">mcmc.alpha</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_lv</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span> <span class="op">+</span> <span class="va">nsite</span><span class="op">)</span><span class="op">]</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## alpha_i of the first two sites</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_alpha</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>

<span class="co">## V_alpha</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_V_alpha</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## Deviance</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcmc_list_Deviance</span>,
     auto.layout<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## probit_theta</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_latent</span>,
     col<span class="op">=</span><span class="fl">1</span>,
     main <span class="op">=</span> <span class="st">"Predicted probit theta"</span>,
     xlab <span class="op">=</span><span class="st">"predicted probit theta"</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">probit_theta_latent</span>,
     add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># occurrence probabilities theta</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">theta_latent</span>,
     col<span class="op">=</span><span class="fl">1</span>, main <span class="op">=</span> <span class="st">"Predicted theta"</span>,
     xlab <span class="op">=</span><span class="st">"predicted theta"</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">theta_latent</span>,
     add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="va">i</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-1.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-2.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-3.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-4.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-5.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-6.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-7.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-8.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-9.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-10.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-11.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-12.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-13.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-14.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-15.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-16.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-17.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-18.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-19.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-20.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-21.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-22.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-23.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-24.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-25.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-26.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-27.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-28.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-29.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-30.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-31.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-32.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-33.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-34.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-35.png" width="700" style="display: block; margin: auto;"><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/plot-results-probit-ord-36.png" width="700" style="display: block; margin: auto;"></p>
<p>Overall, the traces and the densities of the parameters indicate the convergence of the algorithm. Indeed, we observe on the traces that the values oscillate around averages without showing an upward or downward trend and we see that the densities are quite smooth and for the most part of Gaussian form, even for the factor loadings <span class="math inline">\(lambda\)</span> constrained to be positive.</p>
</div>
<div class="section level4">
<h4 id="matrice-of-residual-correlations-1">
<span class="header-section-number">5.3.2</span> Matrice of residual correlations<a class="anchor" aria-label="anchor" href="#matrice-of-residual-correlations-1"></a>
</h4>
<p>After fitting the jSDM with latent variables, the <strong>full species residual correlation matrix</strong> <span class="math inline">\(R=(R_{ij})^{i=1,\ldots, nspecies}_{j=1,\ldots, nspecies}\)</span> can be derived from the covariance in the latent variables such as :
<span class="math display">\[\Sigma_{ij} = \begin{cases}
\lambda_i .\lambda_j^T &amp; \text{ if } i \neq j \\
\lambda_i .\lambda_j^T + 1 &amp; \text{ if } i=j
\end{cases}\]</span>, then we compute correlations from covariances :
<span class="math display">\[R_{i,j} = \frac{\Sigma_{ij}}{\sqrt{\Sigma _{ii}\Sigma _{jj}}}\]</span>.</p>
<p>We use the <code><a href="../reference/get_residual_cor.html">get_residual_cor()</a></code> function to compute the residual correlation matrix <span class="math inline">\(R\)</span> for each chain and we and display the average of the <span class="math inline">\(R\)</span> matrices for all chains:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nsp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model_spec</span><span class="op">$</span><span class="va">beta_start</span><span class="op">)</span>
<span class="co"># Average residual correlation matrix on the four mcmc chains</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nsp</span>, <span class="va">nsp</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nchains</span><span class="op">)</span><span class="op">{</span>
<span class="va">R</span> <span class="op">&lt;-</span> <span class="va">R</span> <span class="op">+</span> <span class="fu"><a href="../reference/get_residual_cor.html">get_residual_cor</a></span><span class="op">(</span><span class="va">mod_Fungi_ord</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">cor.mean</span><span class="op">/</span><span class="va">nchains</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">PA_Fungi</span><span class="op">)</span>
<span class="va">R.reorder</span> <span class="op">&lt;-</span> <span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrMatOrder.html" class="external-link">corrMatOrder</a></span><span class="op">(</span><span class="va">R</span>, order <span class="op">=</span> <span class="st">"FPC"</span>, hclust.method <span class="op">=</span> <span class="st">"average"</span><span class="op">)</span>
<span class="fu">corrplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/corrplot/man/corrplot.html" class="external-link">corrplot</a></span><span class="op">(</span><span class="va">R</span><span class="op">[</span><span class="va">R.reorder</span>,<span class="va">R.reorder</span><span class="op">]</span>,  diag <span class="op">=</span> <span class="cn">F</span>, type <span class="op">=</span> <span class="st">"lower"</span>,
                   method <span class="op">=</span> <span class="st">"color"</span>,  mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span>,
                   tl.srt <span class="op">=</span> <span class="fl">45</span>, tl.cex <span class="op">=</span> <span class="fl">0.7</span>,
                   title <span class="op">=</span> <span class="st">"Residual Correlation Matrix from LVM with selected constrained species"</span><span class="op">)</span></code></pre></div>
<p><img src="jSDM_binomial_probit_sp_constrained_files/figure-html/correlation-matrix-ord-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references">
<div id="ref-Albert1993">
<p>Albert, J.H. &amp; Siddhartha, C. (1993) Bayesian analysis of binary and polychotomous response data. <em>Journal of the American Statistical Association</em>, <strong>88</strong>, 669–679.</p>
</div>
<div id="ref-Brooks1998">
<p>Brooks, S. &amp; Gelman, A. (1998) General Methods for Monitoring Convergence of Iterative Simulations. <em>J. Comput. Graphi. Stat.</em>, <strong>7</strong>, 434–455.</p>
</div>
<div id="ref-Gelman1992">
<p>Gelman, A. &amp; Rubin, D.B. (1992) Inference from Iterative Simulation Using Multiple Sequences. <em>Statistical Science</em>, <strong>7</strong>, 457–472.</p>
</div>
<div id="ref-Warton2015">
<p>Warton, D.I., Blanchet, F.G., O’Hara, R.B., Ovaskainen, O., Taskinen, S., Walker, S.C. &amp; Hui, F.K.C. (2015) So many variables: Joint modeling in community ecology. <em>Trends in Ecology &amp; Evolution</em>, <strong>30</strong>, 766–779.</p>
</div>
<div id="ref-Wilkinson2019">
<p>Wilkinson, D.P., Golding, N., Guillera-Arroita, G., Tingley, R. &amp; McCarthy, M.A. (2019) A comparison of joint species distribution models for presence-absence data. <em>Methods in Ecology and Evolution</em>, <strong>10</strong>, 198–211.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://ecology.ghislainv.fr" class="external-link">Ghislain Vieilledent</a>, <a href="https://www.cirad.fr" class="external-link"><img src="https://ecology.ghislainv.fr/images/logos/logo-cirad.svg" height="24"></a>, Jeanne Clement.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
