---
title: "Bernoulli probit regression with data in long format"
output:
  bookdown::html_document2:
    #base_format: rmarkdown::html_vignette
    #highlight: tango
    number_sections: true
    toc: true
    #toc_float: true
    fig_caption: yes
link-citations: yes
bibliography: bib/biblio-jSDM.bib
biblio-style: bib/jae.bst
csl: bib/journal-of-applied-ecology.csl
pkgdown:
  as_is: true
vignette: >
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteIndexEntry{Bernoulli probit regression with data in long format}
 %\VignetteEncoding{UTF-8}
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(
fig.align = "center",
fig.width = 6, fig.height = 6,
cache = FALSE,
collapse = TRUE,
comment = "#>",
highlight = TRUE
)
```

# Model definition 

Referring to the models used in the articles @Warton2015 and @Albert1993, we define the following model :

$$ \mathrm{probit}(\theta_{ij}) =\alpha_i + \beta_{0j}+X_i.\beta_j+ W_i.\lambda_j $$

- Link function probit: $\mathrm{probit}: q \rightarrow \Phi^{-1}(q)$ where $\Phi$ correspond to the repartition function of the reduced centred normal distribution.

- Response variable: $Y=(y_{ij})^{i=1,\ldots,nsite}_{j=1,\ldots,nsp}$ with:

$$y_{ij}=\begin{cases}
0 & \text{ if species $j$ is absent on the site $i$}\\
1 &  \text{ if species  $j$ is present on the site $i$}.
\end{cases}$$

- Latent variable $z_{ij} = \alpha_i + \beta_{0j} + X_i.\beta_j + W_i.\lambda_j + \epsilon_{i,j}$, with $\forall (i,j) \ \epsilon_{ij} \sim \mathcal{N}(0,1)$ and such that:

$$y_{ij}=\begin{cases}
1 & \text{if} \ z_{ij} > 0 \\
0 &  \text{otherwise.}
\end{cases}$$

It can be easily shown that: $y_{ij} \sim \mathcal{B}ernoulli(\theta_{ij})$. 

- Latent variables: $W_i=(W_i^1,\ldots,W_i^q)$ where $q$ is the number of latent variables considered, which has to be fixed by the user (by default q=2).
We assume that $W_i \sim \mathcal{N}(0,I_q)$ and we define the associated coefficients: $\lambda_j=(\lambda_j^1,\ldots, \lambda_j^q)'$. We use a prior distribution $\mathcal{N}(0,10)$ for all lambdas not concerned by constraints to $0$ on upper diagonal and to strictly positive values on diagonal. 

- Explanatory variables: bioclimatic data about each site. $X=(X_i)_{i=1,\ldots,nsite}$ with $X_i=(x_i^1,\ldots,x_i^p)\in \mathbb{R}^p$ where $p$ is the number of bioclimatic variables considered.
The corresponding regression coefficients for each species $j$ are noted : $\beta_j=(\beta_j^1,\ldots,\beta_j^p)'$.

- $\beta_{0j}$ correspond to the intercept for species $j$ which is assume to be a fixed effect. We use a prior distribution $\mathcal{N}(0,10^6)$ for all betas. 

- $\alpha_i$ represents the random effect of site $i$ such as $\alpha_i \sim \mathcal{N}(0,V_{\alpha})$ and we assumed that $V_{\alpha} \sim \mathcal {IG}(\text{shape}=0.5, \text{rate}=0.005)$ as prior distribution by default. 


# Occurrence data-set

(ref:cap-frog) **_Litoria ewingii_** [@Wilkinson2019].

```{r frog-picture, echo=FALSE, out.width=400, out.height=300, fig.cap="(ref:cap-frog)"}
knitr::include_graphics("figures/Litoria_ewingii.jpg")
```

This data-set is available in the [`jSDM-package`](https://ecology.ghislainv.fr/jSDM/reference/jSDM-package.html) R package. It can be loaded with the `data()` command. The [`frogs`](https://ecology.ghislainv.fr/jSDM/reference/frogs.html) dataset is in "wide" format: each line is a site and the occurrence data (from Species_1 to Species_9) are in columns. A site is characterized by its x-y geographical coordinates, one discrete covariate and two other continuous covariates. 

```{r frogs-data}
library(jSDM)
# frogs data
data(frogs, package="jSDM")
head(frogs)
```

We rearrange the data in two data-sets: a first one for the presence-absence observations for each species (columns) at each site (rows), and a second one for the site characteristics.

We rearrange the data in one `data.frame()` and we normalize the continuous explicative variables to facilitate MCMC convergence. 

```{r arranging-frogs-data}
# data
# Normalized continuous variables
Env_frogs <- cbind(scale(frogs[,1]),frogs[,2],scale(frogs[,3]))
colnames(Env_frogs) <- colnames(frogs[,1:3])
nsite <- nrow(Env_frogs)
PA_frogs <- frogs[,4:12]
nsp <- ncol(PA_frogs)
Y <- c(as.matrix(PA_frogs))
data <- data.frame(Y=Y, species= rep(colnames(PA_frogs),each=nsite),
                   site=rep(1:nsite,nsp))
data <- cbind(data, Env_frogs)
```

# Parameter inference

We use the `jSDM_binomial_probit_block()` function to fit the jSDM (increase the number of iterations to achieve convergence). 

```{r jSDM-probit}
mod_frogs <- jSDM_binomial_probit_block_long_format(
  # Chains
  burnin=1000, mcmc=1000, thin=1,
  # Response variable 
  data=data, 
  # Explanatory variables 
  site_suitability = ~.,   
  # Model specification 
  n_latent=2, site_effect="random",
  # Starting values
  alpha_start=0, beta_start=0,
  lambda_start=0, W_start=0,
  V_alpha=1, 
  # Priors
  shape=0.1, rate=0.1,
  mu_beta=0, V_beta=100,
  mu_lambda=0, V_lambda=10,
  # Various 
  seed=1234, verbose=1)
```

# Analysis of the results

```{r plot-results-probit}
np <- nrow(mod_frogs$model_spec$beta_start)

## beta_j of the first two species
par(mfrow=c(2,2))
for (j in 1:2) {
  for (p in 1:np) {
    coda::traceplot(coda::as.mcmc(mod_frogs$mcmc.sp[[paste0("sp_",j)]][,p]))
    coda::densplot(coda::as.mcmc(mod_frogs$mcmc.sp[[paste0("sp_",j)]][,p]), 
                   main = paste(colnames(mod_frogs$mcmc.sp[[paste0("sp_",j)]])[p],
                                ", species : ",j))
  }
}

## lambda_j of the first two species
n_latent <- mod_frogs$model_spec$n_latent
par(mfrow=c(2,2))
for (j in 1:2) {
  for (l in 1:n_latent) {
    coda::traceplot(coda::as.mcmc(mod_frogs$mcmc.sp[[paste0("sp_",j)]][,np+l]))
    coda::densplot(coda::as.mcmc(mod_frogs$mcmc.sp[[paste0("sp_",j)]][,np+l]), 
                   main = paste(colnames(mod_frogs$mcmc.sp[[paste0("sp_",j)]])
                                [np+l],", species : ",j))
  }
}

## Latent variables W_i for the first two sites
par(mfrow=c(2,2))
for (l in 1:n_latent) {
  for (i in 1:2) {
  coda::traceplot(mod_frogs$mcmc.latent[[paste0("lv_",l)]][,i],
                  main = paste0("Latent variable W_", l, ", site ", i))
  coda::densplot(mod_frogs$mcmc.latent[[paste0("lv_",l)]][,i],
                 main = paste0("Latent variable W_", l, ", site ", i))
  }
}

## alpha_i of the first two sites
plot(coda::as.mcmc(mod_frogs$mcmc.alpha[,1:2]))

## V_alpha
par(mfrow=c(2,2))
coda::traceplot(mod_frogs$mcmc.V_alpha)
coda::densplot(mod_frogs$mcmc.V_alpha)
## Deviance
coda::traceplot(mod_frogs$mcmc.Deviance)
coda::densplot(mod_frogs$mcmc.Deviance)

## probit_theta
par (mfrow=c(2,1))
hist(mod_frogs$probit_theta_pred,
     main = "Predicted probit theta", xlab ="predicted probit theta")
hist(pnorm(mod_frogs$probit_theta_pred),
     main = "Predicted theta", xlab ="predicted theta")
```

# Matrice of correlations 

After fitting the jSDM with latent variables, the **full species residual correlation matrix** $R=(R_{ij})^{i=1,\ldots, nspecies}_{j=1,\ldots, nspecies}$ can be derived from the covariance in the latent variables such as : 
$$\Sigma_{ij} = \begin{cases}
\lambda_i .\lambda_j^T & \text{ if } i \neq j \\
\lambda_i .\lambda_j^T + 1 & \text{ if } i=j
\end{cases}$$, then we compute correlations from covariances :
$$R_{i,j} = \frac{\Sigma_{ij}}{\sqrt{\Sigma _{ii}\Sigma _{jj}}}$$.

We use the `plot_residual_cor()` function to compute and display  the residual correlation matrix :

```{r correlation-matrix-probit}
plot_residual_cor(mod_frogs)
```

# Predictions 

We use the `predict.jSDM()` S3 method on the `mod_frogs` object of class `jSDM` to compute the mean (or expectation) of the posterior distributions obtained and get the expected values of model's parameters.

```{r predictions-probit}
# Sites and species concerned by predictions :
## 50 sites among the 104
nsite_pred <- 50
## All species 
nsp <- length(unique(data$species))
sites <- sort(sample(unique(data$site), nsite_pred))
Id_sites <- rep(sites,nsp)
species <- as.character(unique(data$species))
Id_species <- rep(species,each=nsite_pred)
nobs <- length(Id_species)
# Simulate new observations of covariates on those sites 
simdata <- data.frame(row.names=1:nobs)
simdata$Covariate_1 <- rnorm(nsite_pred)
simdata$Covariate_3 <- rnorm(nsite_pred)
simdata$Covariate_2 <- rbinom(nsite_pred,1,0.5)
# Predictions 
theta_pred <- predict(mod_frogs, newdata=simdata,
                      Id_species=Id_species, Id_sites=Id_sites, type="mean")
hist(theta_pred, main="Predicted theta with simulated data", xlab="predicted theta")
```

# References